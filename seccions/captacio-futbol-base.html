<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Captació Futbol Base | CF Cardona</title>
    <script src="../top-nav.js" defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root{--primary:#d91d1d;--bg:#f1f5f9;--border:#e2e8f0;}
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Inter',sans-serif;}
        body{background:var(--bg);min-height:100vh;padding:2rem;overflow-x:auto;}
        header{max-width:960px;margin:0 auto 2rem;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:1rem;position:relative;z-index:1;}
        h1{color:var(--primary);font-weight:800;font-size:1.5rem;}
        .breadcrumb{font-size:0.85rem;color:#64748b;margin-top:0.25rem;}
        .breadcrumb a{color:var(--primary);text-decoration:none;font-weight:600;}
        .breadcrumb a:hover{text-decoration:underline;}
        .card{background:white;border-radius:1rem;padding:2rem;box-shadow:0 4px 6px -1px rgb(0 0 0/0.1);border:1px solid var(--border);max-width:960px;margin:0 auto 2rem;position:relative;z-index:1;}
        .card h2{color:var(--primary);font-size:1.1rem;font-weight:800;margin-bottom:1.5rem;border-bottom:2px solid #fee2e2;padding-bottom:0.75rem;}
        label{display:block;font-weight:700;font-size:0.82rem;color:#475569;margin-bottom:0.4rem;text-transform:uppercase;letter-spacing:0.05em;}
        textarea{width:100%;min-height:120px;padding:0.75rem;border:1px solid var(--border);border-radius:0.5rem;font-size:0.9rem;outline:none;resize:vertical;line-height:1.6;}
        textarea:focus{border-color:var(--primary);}
        input[type=text],input[type=tel],input[type=number]{width:100%;padding:0.6rem 0.8rem;border:1px solid var(--border);border-radius:0.5rem;font-size:0.9rem;outline:none;}
        input:focus,select:focus{border-color:var(--primary);}
        select{width:100%;padding:0.6rem 0.8rem;border:1px solid var(--border);border-radius:0.5rem;font-size:0.9rem;outline:none;background:white;}
        .btn{padding:0.65rem 1.5rem;border-radius:0.5rem;font-weight:700;cursor:pointer;border:none;font-size:0.88rem;}
        .btn-primary{background:var(--primary);color:white;}
        .btn-primary:hover{background:#b91c1c;}
        .btn-remove{background:none;border:none;color:var(--primary);font-size:1.2rem;cursor:pointer;padding:0 0.25rem;}
        .btn-delete-small { color: #94a3b8; background: none; border: none; cursor: pointer; padding: 0.2rem; font-size: 1rem; }
        .btn-delete-small:hover { color: var(--primary); }

        .scouting-container { display: flex; gap: 2rem; align-items: flex-start; }
        .scouting-sidebar { width: 350px; flex-shrink: 0; background: white; border-radius: 1rem; border: 1px solid var(--border); padding: 1.5rem; max-height: 800px; overflow-y: auto; }
        .scouting-content { flex: 1; min-width: 0; }
        
        .scouting-list { display: grid; gap: 0.75rem; }
        .scouting-list-item { padding: 1rem; background: #fffafa; border: 1px solid #fecaca; border-radius: 0.75rem; cursor: pointer; transition: all 0.2s; position: relative; }
        .scouting-list-item:hover { transform: translateX(5px); background: #fee2e2; }
        .scouting-list-item.active { border-left: 5px solid var(--primary); background: #fee2e2; }
        .scouting-list-name { font-weight: 800; color: var(--primary); font-size: 1rem; }
        .scouting-list-meta { font-size: 0.75rem; color: #64748b; margin-top: 0.2rem; }

        .scouting-detail-card { background: white; border-radius: 1rem; padding: 2rem; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgb(0 0 0/0.1); }
        .scouting-header-actions { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; border-bottom: 2px solid #fee2e2; padding-bottom: 1rem; }
        .scouting-header-actions h2 { margin: 0; border: none; padding: 0; }
        
        .obs-list { margin-bottom: 1rem; }
        .obs-item { background: #fffafa; border: 1px solid #fecaca; border-radius: 0.75rem; padding: 1rem 1.25rem; margin-bottom: 0.75rem; }
        .obs-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .obs-meta { font-size: 0.82rem; color: #64748b; }
        .obs-meta strong { color: var(--primary); }
        .obs-text { font-size: 0.9rem; line-height: 1.6; white-space: pre-wrap; }
        .add-obs-form { background: #f8fafc; border: 1px solid var(--border); border-radius: 0.75rem; padding: 1.25rem; }
        .form-title { font-size: 0.82rem; font-weight: 800; text-transform: uppercase; color: #475569; margin-bottom: 1rem; }
        .obs-form-row { display: grid; grid-template-columns: 1fr 1fr auto; gap: 0.75rem; margin-bottom: 0.75rem; align-items: end; }
        .empty-msg { color: #94a3b8; font-size: 0.85rem; padding: 0.5rem; }

        .pos-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 0.5rem; padding: 0.5rem; background: #fff5f5; border: 1px solid #fecaca; border-radius: 0.5rem; margin-top: 0.4rem; }
        .pos-item { display: flex; align-items: center; gap: 0.5rem; font-size: 0.8rem; font-weight: 600; cursor: pointer; }
        .pos-item input { width: auto; }
        .scouting-form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
        
        .gender-badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
        .gender-masculi { background: #dbeafe; color: #1d4ed8; }
        .gender-femeni { background: #fce7f3; color: #be185d; }
        .year-badge { background: #fef9c3; color: #854d0e; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.75rem; font-weight: 700; }

        @media(max-width:768px){
            .scouting-container { flex-direction: column; }
            .scouting-sidebar { width: 100%; max-height: 400px; }
        }
    </style>
</head>
<body>
    <header>
        <div>
            <h1>&#x1F31F; Captació Futbol Base</h1>
            <div class="breadcrumb"><a href="../index.html">Inici</a> &rarr; <a href="../estructura.html">Estructura Esportiva</a> &rarr; <a href="futbol-base.html">Futbol Base</a> &rarr; Captació</div>
        </div>
    </header>
    <div class="scouting-container">
        <!-- Sidebar: Llista de jugadors -->
        <div class="scouting-sidebar">
            <h2 style="color:var(--primary); font-size:1rem; margin-bottom:1rem; border-bottom:1px solid #fee2e2; padding-bottom:0.5rem;">&#x1F465; Jugadors en Cartera</h2>
            <div id="scouting_list" class="scouting-list">
                <!-- Injected by JS -->
            </div>
            <button class="btn btn-primary" onclick="showAddForm()" style="width:100%; margin-top:1.5rem; font-size:0.8rem;">+ NOU JUGADOR</button>
        </div>

        <!-- Main: Detalls o Formulari -->
        <div class="scouting-content">
            <div id="scouting_main_view">
                <div class="card" style="text-align:center; padding:5rem 2rem;">
                    <span style="font-size:3rem;">&#x1F31F;</span>
                    <p style="color:#94a3b8; margin-top:1rem;">Selecciona un jugador per veure'n els detalls o afegeix-ne un de nou.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden Template per al formulari d'alta -->
    <template id="tpl_add_form">
        <div class="card">
            <h2>&#x2728; Nou Jugador a la Cartera</h2>
            <div class="scouting-form-grid">
                <div><label>Nom i Cognoms</label><input type="text" id="sc_nom" placeholder="Ex: Joan Ferran..."></div>
                <div><label>Club Actual</label><input type="text" id="sc_club" placeholder="Ex: CE Manresa..."></div>
                <div><label>Tel&egrave;fon</label><input type="tel" id="sc_tel" placeholder="Ex: 600 000 000..."></div>
                <div><label>Poblaci&oacute;</label><input type="text" id="sc_poblacio" placeholder="Ex: Manresa..."></div>
                <div><label>Any de Naixement</label><input type="number" id="sc_any_naixement" placeholder="Ex: 2015..." min="2005" max="2025"></div>
                <div>
                    <label>Gènere</label>
                    <select id="sc_genere">
                        <option value="">-- Selecciona --</option>
                        <option value="Masculí">Masculí</option>
                        <option value="Femení">Femení</option>
                    </select>
                </div>
            </div>
            <div style="margin-bottom:1.5rem;">
                <label>Posicionament (pots marcar varies)</label>
                <div class="pos-grid">
                    <label class="pos-item"><input type="checkbox" name="sc_pos" value="Porter"> Porter</label>
                    <label class="pos-item"><input type="checkbox" name="sc_pos" value="Lateral Dret"> Lateral Dret</label>
                    <label class="pos-item"><input type="checkbox" name="sc_pos" value="Lateral Esquerre"> Lateral Esquerre</label>
                    <label class="pos-item"><input type="checkbox" name="sc_pos" value="Central"> Central</label>
                    <label class="pos-item"><input type="checkbox" name="sc_pos" value="Pivot Defensiu"> Pivot Defensiu</label>
                    <label class="pos-item"><input type="checkbox" name="sc_pos" value="Interior"> Interior</label>
                    <label class="pos-item"><input type="checkbox" name="sc_pos" value="Mitja Punta"> Mitja Punta</label>
                    <label class="pos-item"><input type="checkbox" name="sc_pos" value="Extrem Dret"> Extrem Dret</label>
                    <label class="pos-item"><input type="checkbox" name="sc_pos" value="Extrem Esquerre"> Extrem Esquerre</label>
                    <label class="pos-item"><input type="checkbox" name="sc_pos" value="Davanter Centre"> Davanter Centre</label>
                </div>
            </div>
            <div style="margin-bottom:1rem;">
                <label>Situaci&oacute; / Perfil r&agrave;pid</label>
                <textarea id="sc_situacio" style="min-height:80px;" placeholder="Ex: Interès en canviar d'equip..."></textarea>
            </div>
            <div style="display:flex; gap:1rem;">
                <button class="btn btn-primary" onclick="addPlayer()" style="flex:2;">GUARDAR JUGADOR</button>
                <button class="btn" onclick="clearMainView()" style="background:#e2e8f0; flex:1;">CANCEL·LAR</button>
            </div>
        </div>
    </template>
    
    <script>
        const SEGMENT='base';
        const API_SEGUIMENT=`/api/jugadors-seguiment?segment=${SEGMENT}`;
        const ALL_POSITIONS = ['Porter', 'Lateral Dret', 'Lateral Esquerre', 'Central', 'Pivot Defensiu', 'Interior', 'Mitja Punta', 'Extrem Dret', 'Extrem Esquerre', 'Davanter Centre'];
        let players=[], selectedId=null;

        async function load(){
            try {
                const r=await fetch(API_SEGUIMENT);
                if(!r.ok){
                    const errorText=await r.text();
                    throw new Error(`GET seguiment ${r.status}: ${errorText}`);
                }
                players = await r.json();
                if(!Array.isArray(players)) players = [];
                renderList();
            } catch(e) { 
                console.warn('Servidor no disponible');
                players = [];
                renderList();
            }
        }

        function renderList(){
            const list = document.getElementById('scouting_list');
            if(!players.length){
                list.innerHTML = '<div style="text-align:center; color:#94a3b8; padding:2rem 1rem; font-size:0.85rem;">Encara no hi ha jugadors registrats.</div>';
                return;
            }
            list.innerHTML = players.map((p,i)=>{
                const genderClass = p.genere === 'Masculí' ? 'gender-masculi' : 'gender-femeni';
                const genderLabel = p.genere || 'N/D';
                return `
                    <div class="scouting-list-item ${selectedId===i?'active':''}" onclick="selectPlayer(${i})">
                        <div class="scouting-list-name">${esc(p.nom)}</div>
                        <div class="scouting-list-meta">
                            <span class="gender-badge ${genderClass}">${genderLabel}</span>
                            <span class="year-badge">${p.any_naixement || 'N/D'}</span>
                            ${p.club ? ' · '+esc(p.club) : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function selectPlayer(i){
            selectedId = i;
            renderList();
            renderDetails();
        }

        function renderDetails(){
            const p = players[selectedId];
            if(!p) return;
            const mainView = document.getElementById('scouting_main_view');
            const genderClass = p.genere === 'Masculí' ? 'gender-masculi' : 'gender-femeni';
            const contactesHtml = renderContactes();
            mainView.innerHTML = `
                <div class="scouting-detail-card">
                    <div class="scouting-header-actions">
                        <h2>&#x1F464; ${esc(p.nom)}</h2>
                        <button class="btn" onclick="deletePlayer()" style="background:#fee2e2; color:var(--primary);">&#x1F5D1; ELIMINAR</button>
                    </div>
                    <div style="display:grid; gap:1rem;">
                        <div><label>Nom i Cognoms</label><input type="text" value="${esc(p.nom)}" onchange="updateField('nom', this.value)"></div>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:1rem;">
                            <div><label>Club Actual</label><input type="text" value="${esc(p.club||'')}" onchange="updateField('club', this.value)"></div>
                            <div><label>Població</label><input type="text" value="${esc(p.poblacio||'')}" onchange="updateField('poblacio', this.value)"></div>
                        </div>
                        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:1rem;">
                            <div><label>Telèfon</label><input type="tel" value="${esc(p.tel||'')}" onchange="updateField('tel', this.value)"></div>
                            <div><label>Any de Naixement</label><input type="number" value="${p.any_naixement||''}" min="2005" max="2025" onchange="updateField('any_naixement', parseInt(this.value))"></div>
                            <div>
                                <label>Gènere</label>
                                <select onchange="updateField('genere', this.value)">
                                    <option value="" ${!p.genere?'selected':''}>-- Selecciona --</option>
                                    <option value="Masculí" ${p.genere==='Masculí'?'selected':''}>Masculí</option>
                                    <option value="Femení" ${p.genere==='Femení'?'selected':''}>Femení</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label>Posicions</label>
                            <div class="pos-grid">
                                ${ALL_POSITIONS.map(pos=>`
                                    <label class="pos-item">
                                        <input type="checkbox" value="${pos}" ${(p.posicions||[]).includes(pos)?'checked':''} onchange="togglePosition('${pos}', this.checked)"> ${pos}
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                        <div><label>Situació / Perfil</label><textarea onchange="updateField('situacio', this.value)">${esc(p.situacio||'')}</textarea></div>
                        
                        <div style="border-top: 2px solid #fee2e2; padding-top: 1.5rem; margin-top: 1rem;">
                            <h3 style="color: var(--primary); font-size: 0.95rem; font-weight: 700; margin-bottom: 1rem;">💬 Observacions i Comentaris</h3>
                            <div class="obs-list">${contactesHtml}</div>
                            <div class="add-obs-form">
                                <div class="form-title">Nou Comentari</div>
                                <div class="obs-form-row">
                                    <div><label style="font-size: 0.75rem;">Autor</label><input type="text" id="contacte_autor" placeholder="Qui fa el comentari..."></div>
                                    <div><label style="font-size: 0.75rem;">Data</label><input type="date" id="contacte_data"></div>
                                    <div><button class="btn btn-primary" onclick="addContacte()" style="font-size: 0.8rem; padding: 0.5rem 1rem;">AFEGIR</button></div>
                                </div>
                                <div><label style="font-size: 0.75rem;">Comentari</label><textarea id="contacte_nota" style="min-height:100px;" placeholder="Escriu el comentari..."></textarea></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            const dataEl = document.getElementById('contacte_data');
            if(dataEl && !dataEl.value){
                dataEl.value = today;
            }
        }

        function renderContactes(){
            const p = players[selectedId];
            if(!p) return '';
            const contactes = p.contactes || [];
            if(!contactes.length){
                return '<div class="empty-msg">Sense observacions registrades.</div>';
            }
            return contactes.map((c, idx) => `
                <div class="obs-item">
                    <div class="obs-header">
                        <div class="obs-meta"><strong>${esc(c.autor || 'Anònim')}</strong> &mdash; ${fmtDate(c.data)}</div>
                        <button class="btn-remove" onclick="deleteContacte(${idx})" title="Eliminar comentari">&#x00D7;</button>
                    </div>
                    <div class="obs-text">${esc(c.nota || '')}</div>
                </div>
            `).join('');
        }

        async function addContacte(){
            const today = new Date().toISOString().split('T')[0];
            const autor = (document.getElementById('contacte_autor')?.value || '').trim() || 'Anònim';
            const data = document.getElementById('contacte_data').value;
            const nota = document.getElementById('contacte_nota').value.trim();
            if(!data || !nota){alert('Completa data i nota del contacte.'); return;}
            
            if(!players[selectedId].contactes) players[selectedId].contactes = [];
            players[selectedId].contactes.push({autor, data, nota});
            if(document.getElementById('contacte_autor')) document.getElementById('contacte_autor').value = '';
            document.getElementById('contacte_data').value = today;
            document.getElementById('contacte_nota').value = '';
            const player = players[selectedId];
            if(player && player.id){
                try{
                    const r = await fetch(API_SEGUIMENT,{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:player.id,contactes:player.contactes})});
                    if(!r.ok){
                        const errorText = await r.text();
                        throw new Error(`PATCH contactes ${r.status}: ${errorText}`);
                    }
                }catch(e){
                    console.warn('Error actualitzant contactes');
                }
            }
            renderDetails();
        }

        async function deleteContacte(idx){
            if(!confirm('Segur que vols eliminar aquest contacte?')) return;
            players[selectedId].contactes.splice(idx, 1);
            const player = players[selectedId];
            if(player && player.id){
                try{
                    const r = await fetch(API_SEGUIMENT,{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:player.id,contactes:player.contactes})});
                    if(!r.ok){
                        const errorText = await r.text();
                        throw new Error(`PATCH contactes ${r.status}: ${errorText}`);
                    }
                }catch(e){
                    console.warn('Error actualitzant contactes');
                }
            }
            renderDetails();
        }

        function showAddForm(){
            const mainView = document.getElementById('scouting_main_view');
            const tpl = document.getElementById('tpl_add_form');
            mainView.innerHTML = tpl.innerHTML;
            selectedId = null;
            renderList();
        }

        function clearMainView(){
            selectedId = null;
            renderList();
            document.getElementById('scouting_main_view').innerHTML = `
                <div class="card" style="text-align:center; padding:5rem 2rem;">
                    <span style="font-size:3rem;">&#x1F31F;</span>
                    <p style="color:#94a3b8; margin-top:1rem;">Selecciona un jugador per veure'n els detalls o afegeix-ne un de nou.</p>
                </div>
            `;
        }

        async function addPlayer(){
            const nom = document.getElementById('sc_nom').value.trim();
            if(!nom){alert('El nom és obligatori.'); return;}
            const any_naixement = parseInt(document.getElementById('sc_any_naixement').value) || null;
            if(!any_naixement){alert('L\'any de naixement és obligatori.'); return;}
            const genere = document.getElementById('sc_genere').value.trim();
            if(!genere){alert('El gènere és obligatori.'); return;}
            const club = document.getElementById('sc_club').value.trim();
            const tel = document.getElementById('sc_tel').value.trim();
            const poblacio = document.getElementById('sc_poblacio').value.trim();
            const situacio = document.getElementById('sc_situacio').value.trim();
            const posicions = Array.from(document.querySelectorAll('input[name="sc_pos"]:checked')).map(cb=>cb.value);

            try{
                const r = await fetch(API_SEGUIMENT,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({nom, club, tel, poblacio, any_naixement, genere, posicions, situacio, contactes:[]})});
                if(!r.ok){
                    const errorText = await r.text();
                    throw new Error(`POST seguiment ${r.status}: ${errorText}`);
                }
                const payload = await r.json();
                if(payload && payload.jugador){
                    players.push(payload.jugador);
                }
            }catch(e){
                alert('Error al guardar jugador en seguiment');
                return;
            }
            renderList();
            clearMainView();
        }

        async function deletePlayer(){
            if(!confirm('Segur que vols eliminar aquest jugador?')) return;
            const player = players[selectedId];
            if(!player) return;

            try{
                const r = await fetch(`${API_SEGUIMENT}&id=${encodeURIComponent(player.id)}`,{method:'DELETE'});
                if(!r.ok){
                    const errorText = await r.text();
                    throw new Error(`DELETE seguiment ${r.status}: ${errorText}`);
                }
            }catch(e){
                alert('Error al eliminar jugador');
                return;
            }

            players.splice(selectedId, 1);
            clearMainView();
            renderList();
        }

        async function updateField(field, value){
            players[selectedId][field] = value;
            const player = players[selectedId];
            if(player && player.id){
                try{
                    const r = await fetch(API_SEGUIMENT,{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:player.id,[field]:value})});
                    if(!r.ok){
                        const errorText = await r.text();
                        throw new Error(`PATCH seguiment ${r.status}: ${errorText}`);
                    }
                }catch(e){
                    console.warn('Error actualitzant camp de seguiment');
                }
            }
            renderList();
        }

        async function togglePosition(pos, checked){
            if(!players[selectedId].posicions) players[selectedId].posicions = [];
            if(checked){
                if(!players[selectedId].posicions.includes(pos)){
                    players[selectedId].posicions.push(pos);
                }
            } else {
                players[selectedId].posicions = players[selectedId].posicions.filter(p=>p!==pos);
            }
            const player = players[selectedId];
            if(player && player.id){
                try{
                    const r = await fetch(API_SEGUIMENT,{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:player.id,posicions:players[selectedId].posicions})});
                    if(!r.ok){
                        const errorText = await r.text();
                        throw new Error(`PATCH posicions ${r.status}: ${errorText}`);
                    }
                }catch(e){
                    console.warn('Error actualitzant posicions de seguiment');
                }
            }
            renderList();
        }

        function esc(str){
            if(!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function fmtDate(d){
            if(!d) return '-';
            return new Date(d+'T12:00:00').toLocaleDateString('ca-ES',{day:'2-digit',month:'2-digit',year:'numeric'});
        }

        const today = new Date().toISOString().split('T')[0];
        window.onload = load;
    </script>
</body>
</html>


