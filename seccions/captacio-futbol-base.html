<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Captació Futbol Base | CF Cardona</title>
    <script src="../top-nav.js" defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #d91d1d;
            --bg: #f1f5f9;
            --border: #e2e8f0;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }
        body {
            background: var(--bg);
            min-height: 100vh;
            padding: 1rem;
        }
        .page-wrap {
            max-width: 960px;
            margin: 0 auto;
        }
        .screen {
            width: 100%;
            min-height: calc(100vh - 130px);
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            padding: 1.25rem;
        }
        .hidden {
            display: none;
        }
        .screen-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        .screen-title {
            color: var(--primary);
            font-weight: 800;
            font-size: 1.1rem;
            letter-spacing: 0.01em;
        }
        .btn {
            border: 1px solid transparent;
            border-radius: 0.55rem;
            font-size: 0.84rem;
            font-weight: 800;
            padding: 0.58rem 0.95rem;
            cursor: pointer;
        }
        .btn-primary {
            background: var(--primary);
            color: #fff;
        }
        .btn-primary:hover {
            background: #b91c1c;
        }
        .btn-muted {
            background: #f1f5f9;
            border-color: #cbd5e1;
            color: #0f172a;
        }
        .filters-row {
            display: grid;
            grid-template-columns: 140px 170px 1fr 210px;
            gap: 0.75rem;
            margin-bottom: 1rem;
            align-items: end;
        }
        label {
            display: block;
            margin-bottom: 0.35rem;
            color: #475569;
            font-size: 0.74rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        select,
        input[type=text],
        input[type=tel],
        input[type=number],
        textarea {
            width: 100%;
            border: 1px solid var(--border);
            border-radius: 0.55rem;
            padding: 0.62rem 0.78rem;
            font-size: 0.88rem;
            outline: none;
            background: #fff;
        }
        textarea {
            min-height: 110px;
            resize: vertical;
            line-height: 1.45;
        }
        select:focus,
        input:focus,
        textarea:focus {
            border-color: var(--primary);
        }
        .players-table-wrap {
            border: 1px solid var(--border);
            border-radius: 0.8rem;
            overflow: auto;
            background: #fff;
        }
        .players-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 760px;
        }
        .players-table th,
        .players-table td {
            border-bottom: 1px solid #e2e8f0;
            text-align: left;
            padding: 0.72rem 0.75rem;
            vertical-align: middle;
            font-size: 0.82rem;
            white-space: normal;
        }
        .players-table th {
            background: #fee2e2;
            color: var(--primary);
            font-weight: 700;
            font-size: 0.78rem;
        }
        .players-table tr:last-child td {
            border-bottom: 0;
        }
        .players-table tbody tr:hover {
            background: #fff5f5;
        }
        .name-cell {
            font-weight: 700;
        }
        .name-link {
            color: #b91c1c;
            text-decoration: none;
            font-weight: 800;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 0.82rem;
            padding: 0.2rem 0.35rem;
            border-radius: 0.45rem;
            transition: background 0.15s, color 0.15s;
            text-align: left;
            white-space: normal;
            display: inline-block;
        }
        .name-link:hover {
            color: #991b1b;
            background: #fff1f2;
        }
        .delete-x {
            border: none;
            background: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 800;
            line-height: 1;
            padding: 0;
        }
        .delete-x:hover {
            color: #991b1b;
        }
        .empty {
            padding: 2.25rem 1rem;
            text-align: center;
            color: #94a3b8;
            font-size: 0.86rem;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 0.75rem;
            margin-bottom: 0.9rem;
        }
        .form-grid .full {
            grid-column: 1 / -1;
        }
        .pos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(165px, 1fr));
            gap: 0.5rem;
            padding: 0.6rem;
            background: #fff5f5;
            border: 1px solid #fecaca;
            border-radius: 0.6rem;
        }
        .pos-item {
            display: flex;
            align-items: center;
            gap: 0.45rem;
            font-size: 0.8rem;
            font-weight: 600;
            color: #334155;
        }
        .form-actions {
            margin-top: 1rem;
            display: flex;
            gap: 0.6rem;
            justify-content: flex-end;
        }

        @media (max-width: 900px) {
            .filters-row {
                grid-template-columns: 1fr;
            }
            .form-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <main class="page-wrap">
        <section id="listScreen" class="screen">
            <div class="screen-header">
                <h1 class="screen-title">Jugadors en captació futbol base</h1>
                <button class="btn btn-primary" id="btnNewPlayer" type="button">+ Alta jugador</button>
            </div>

            <div class="filters-row">
                <div>
                    <label for="filterYear">Filtre per any</label>
                    <select id="filterYear"></select>
                </div>
                <div>
                    <label for="filterGender">Filtre per gènere</label>
                    <select id="filterGender"></select>
                </div>
                <div>
                    <label for="filterName">Filtre per nom</label>
                    <input id="filterName" type="text" placeholder="Escriu per filtrar...">
                </div>
                <div>
                    <label for="filterClub">Filtre per club</label>
                    <select id="filterClub"></select>
                </div>
            </div>

            <div class="players-table-wrap">
                <table class="players-table">
                    <thead>
                        <tr>
                            <th>Jugador</th>
                            <th>Any</th>
                            <th>Gènere</th>
                            <th>Club</th>
                            <th>Posicions</th>
                            <th>✕</th>
                        </tr>
                    </thead>
                    <tbody id="playersBody"></tbody>
                </table>
                <div id="playersEmpty" class="empty hidden">No hi ha jugadors amb aquest filtre.</div>
            </div>
        </section>

        <section id="formScreen" class="screen hidden">
            <div class="screen-header">
                <h2 class="screen-title" id="formTitle">Alta jugador</h2>
                <button class="btn btn-muted" id="btnBackToList" type="button">Tornar al llistat</button>
            </div>

            <form id="playerForm">
                <div class="form-grid">
                    <div>
                        <label for="f_nom">Nom i cognoms</label>
                        <input id="f_nom" type="text" required>
                    </div>
                    <div>
                        <label for="f_any">Any de naixement</label>
                        <input id="f_any" type="number" min="2000" max="2030" required>
                    </div>
                    <div>
                        <label for="f_genere">Gènere</label>
                        <select id="f_genere" required>
                            <option value="">-- Selecciona --</option>
                            <option value="Masculí">Masculí</option>
                            <option value="Femení">Femení</option>
                        </select>
                    </div>
                    <div>
                        <label for="f_club">Club actual</label>
                        <input id="f_club" type="text">
                    </div>
                    <div>
                        <label for="f_tel">Telèfon</label>
                        <input id="f_tel" type="tel">
                    </div>
                    <div>
                        <label for="f_poblacio">Població</label>
                        <input id="f_poblacio" type="text">
                    </div>

                    <div class="full">
                        <label>Posicions</label>
                        <div id="positionsGrid" class="pos-grid"></div>
                    </div>

                    <div class="full">
                        <label for="f_situacio">Situació / perfil ràpid</label>
                        <textarea id="f_situacio"></textarea>
                    </div>
                </div>

                <div class="form-actions">
                    <button class="btn btn-muted" id="btnCancelForm" type="button">Cancel·lar</button>
                    <button class="btn btn-primary" type="submit">Guardar</button>
                </div>
            </form>
        </section>
    </main>

    <script>
        const SEGMENT = 'base';
        const API_SEGUIMENT = `/api/jugadors-seguiment?segment=${SEGMENT}`;
        const API_POSICIONS = '/api/posicions';
        const DEFAULT_POSITIONS = [
            'Porter', 'Lateral Dret', 'Lateral Esquerre', 'Central', 'Pivot Defensiu',
            'Interior', 'Mitja Punta', 'Extrem Dret', 'Extrem Esquerre', 'Davanter Centre'
        ];

        let players = [];
        let allPositions = [...DEFAULT_POSITIONS];
        let selectedYearFilter = '__ALL__';
        let selectedGenderFilter = '__ALL__';
        let selectedClubFilter = '__ALL__';
        let nameFilterValue = '';
        let editingPlayerId = null;

        function esc(value) {
            const div = document.createElement('div');
            div.textContent = String(value || '');
            return div.innerHTML;
        }

        function normalizePositionList(list) {
            return [...new Set((Array.isArray(list) ? list : [])
                .map(item => {
                    if (item && typeof item === 'object') return String(item.nom || item.name || item.value || '').trim();
                    return String(item || '').trim();
                })
                .filter(Boolean))];
        }

        function showListScreen() {
            document.getElementById('listScreen').classList.remove('hidden');
            document.getElementById('formScreen').classList.add('hidden');
        }

        function showFormScreen() {
            document.getElementById('listScreen').classList.add('hidden');
            document.getElementById('formScreen').classList.remove('hidden');
        }

        async function loadPositions() {
            try {
                const r = await fetch(API_POSICIONS);
                if (!r.ok) throw new Error('No s\'han pogut carregar les posicions');
                const payload = await r.json();
                const list = normalizePositionList(payload);
                if (list.length) allPositions = list;
            } catch (_) {
                allPositions = [...DEFAULT_POSITIONS];
            }
        }

        async function loadPlayers() {
            const r = await fetch(API_SEGUIMENT);
            if (!r.ok) throw new Error('No s\'han pogut carregar els jugadors');
            const data = await r.json();
            players = Array.isArray(data) ? data : [];
        }

        function renderYearFilter() {
            const select = document.getElementById('filterYear');
            const years = [...new Set(players
                .map(player => Number.parseInt(player.any_naixement, 10))
                .filter(Number.isInteger))]
                .sort((a, b) => b - a);

            if (selectedYearFilter !== '__ALL__' && !years.includes(Number(selectedYearFilter))) {
                selectedYearFilter = '__ALL__';
            }

            select.innerHTML = [
                '<option value="__ALL__">Tots els anys</option>',
                ...years.map(year => `<option value="${year}">${year}</option>`)
            ].join('');
            select.value = selectedYearFilter;
        }

        function renderGenderFilter() {
            const select = document.getElementById('filterGender');
            const genders = [...new Set(players.map(player => String(player.genere || '').trim()).filter(Boolean))]
                .sort((a, b) => a.localeCompare(b, 'ca'));

            if (selectedGenderFilter !== '__ALL__' && !genders.includes(selectedGenderFilter)) {
                selectedGenderFilter = '__ALL__';
            }

            select.innerHTML = [
                '<option value="__ALL__">Tots els gèneres</option>',
                ...genders.map(gender => `<option value="${esc(gender)}">${esc(gender)}</option>`)
            ].join('');
            select.value = selectedGenderFilter;
        }

        function renderClubFilter() {
            const select = document.getElementById('filterClub');
            const clubs = [...new Set(players.map(player => String(player.club || '').trim()).filter(Boolean))]
                .sort((a, b) => a.localeCompare(b, 'ca'));

            if (selectedClubFilter !== '__ALL__' && !clubs.includes(selectedClubFilter)) {
                selectedClubFilter = '__ALL__';
            }

            select.innerHTML = [
                '<option value="__ALL__">Tots els clubs</option>',
                ...clubs.map(club => `<option value="${esc(club)}">${esc(club)}</option>`)
            ].join('');
            select.value = selectedClubFilter;
        }

        function getFilteredPlayers() {
            const q = nameFilterValue.toLocaleLowerCase('ca').trim();
            return players.filter(player => {
                const playerYear = Number.parseInt(player.any_naixement, 10);
                const byYear = selectedYearFilter === '__ALL__' || playerYear === Number(selectedYearFilter);
                const byGender = selectedGenderFilter === '__ALL__' || String(player.genere || '').trim() === selectedGenderFilter;
                const byClub = selectedClubFilter === '__ALL__' || String(player.club || '').trim() === selectedClubFilter;
                const byName = !q || String(player.nom || '').toLocaleLowerCase('ca').includes(q);
                return byYear && byGender && byClub && byName;
            });
        }

        function renderPlayersTable() {
            const body = document.getElementById('playersBody');
            const empty = document.getElementById('playersEmpty');
            const rows = getFilteredPlayers();

            if (!rows.length) {
                body.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }

            empty.classList.add('hidden');
            body.innerHTML = rows.map(player => {
                const posicions = normalizePositionList(player.posicions).join(', ') || '-';
                return `
                    <tr>
                        <td class="name-cell"><button type="button" class="name-link" data-action="edit" data-id="${esc(player.id)}">${esc(player.nom)}</button></td>
                        <td>${esc(player.any_naixement || '-')}</td>
                        <td>${esc(player.genere || '-')}</td>
                        <td>${esc(player.club || '-')}</td>
                        <td>${esc(posicions)}</td>
                        <td><button type="button" class="delete-x" title="Eliminar" data-action="delete" data-id="${esc(player.id)}">✕</button></td>
                    </tr>
                `;
            }).join('');
        }

        function renderPositionChecks(selected = []) {
            const selectedSet = new Set(normalizePositionList(selected));
            const grid = document.getElementById('positionsGrid');
            grid.innerHTML = allPositions.map(pos => `
                <label class="pos-item">
                    <input type="checkbox" name="f_pos" value="${esc(pos)}" ${selectedSet.has(pos) ? 'checked' : ''}>
                    <span>${esc(pos)}</span>
                </label>
            `).join('');
        }

        function getPlayerById(id) {
            return players.find(player => String(player.id) === String(id));
        }

        function openCreateForm() {
            editingPlayerId = null;
            document.getElementById('formTitle').textContent = 'Alta jugador';
            document.getElementById('playerForm').reset();
            renderPositionChecks([]);
            showFormScreen();
        }

        function openEditForm(playerId) {
            const player = getPlayerById(playerId);
            if (!player) return;
            editingPlayerId = player.id;
            document.getElementById('formTitle').textContent = 'Modificar jugador';
            document.getElementById('f_nom').value = player.nom || '';
            document.getElementById('f_any').value = player.any_naixement || '';
            document.getElementById('f_genere').value = player.genere || '';
            document.getElementById('f_club').value = player.club || '';
            document.getElementById('f_tel').value = player.tel || '';
            document.getElementById('f_poblacio').value = player.poblacio || '';
            document.getElementById('f_situacio').value = player.situacio || '';
            renderPositionChecks(player.posicions || []);
            showFormScreen();
        }

        function getFormPayload() {
            const nom = document.getElementById('f_nom').value.trim();
            const anyNaixement = Number.parseInt(document.getElementById('f_any').value, 10);
            const genere = document.getElementById('f_genere').value.trim();

            if (!nom) {
                alert('El nom és obligatori.');
                return null;
            }
            if (!Number.isInteger(anyNaixement)) {
                alert('L\'any de naixement és obligatori.');
                return null;
            }
            if (!genere) {
                alert('El gènere és obligatori.');
                return null;
            }

            return {
                nom,
                any_naixement: anyNaixement,
                genere,
                club: document.getElementById('f_club').value.trim(),
                tel: document.getElementById('f_tel').value.trim(),
                poblacio: document.getElementById('f_poblacio').value.trim(),
                situacio: document.getElementById('f_situacio').value.trim(),
                posicions: normalizePositionList(Array.from(document.querySelectorAll('input[name="f_pos"]:checked')).map(cb => cb.value))
            };
        }

        async function savePlayer(event) {
            event.preventDefault();
            const payload = getFormPayload();
            if (!payload) return;

            try {
                if (editingPlayerId === null) {
                    const r = await fetch(API_SEGUIMENT, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ...payload, contactes: [] })
                    });
                    if (!r.ok) throw new Error('No s\'ha pogut crear el jugador');
                    const response = await r.json();
                    if (response?.jugador) {
                        players.push(response.jugador);
                    }
                } else {
                    const r = await fetch(API_SEGUIMENT, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id: editingPlayerId, ...payload })
                    });
                    if (!r.ok) throw new Error('No s\'ha pogut actualitzar el jugador');

                    const idx = players.findIndex(p => String(p.id) === String(editingPlayerId));
                    if (idx >= 0) {
                        players[idx] = { ...players[idx], ...payload };
                    }
                }

                renderYearFilter();
                renderGenderFilter();
                renderClubFilter();
                renderPlayersTable();
                showListScreen();
            } catch (_) {
                alert('Error guardant el jugador.');
            }
        }

        async function removePlayer(playerId) {
            if (!confirm('Segur que vols eliminar aquest jugador?')) return;
            try {
                const r = await fetch(`${API_SEGUIMENT}&id=${encodeURIComponent(playerId)}`, { method: 'DELETE' });
                if (!r.ok) throw new Error('No s\'ha pogut eliminar el jugador');
                players = players.filter(player => String(player.id) !== String(playerId));
                renderYearFilter();
                renderGenderFilter();
                renderClubFilter();
                renderPlayersTable();
            } catch (_) {
                alert('Error eliminant el jugador.');
            }
        }

        async function init() {
            try {
                await loadPositions();
                await loadPlayers();
                renderYearFilter();
                renderGenderFilter();
                renderClubFilter();
                renderPlayersTable();
                renderPositionChecks([]);
            } catch (_) {
                renderYearFilter();
                renderGenderFilter();
                renderClubFilter();
                renderPlayersTable();
                alert('No s\'ha pogut carregar la informació de captació.');
            }

            document.getElementById('btnNewPlayer').addEventListener('click', openCreateForm);
            document.getElementById('btnBackToList').addEventListener('click', showListScreen);
            document.getElementById('btnCancelForm').addEventListener('click', showListScreen);
            document.getElementById('playerForm').addEventListener('submit', savePlayer);

            document.getElementById('filterYear').addEventListener('change', (event) => {
                selectedYearFilter = event.target.value;
                renderPlayersTable();
            });

            document.getElementById('filterGender').addEventListener('change', (event) => {
                selectedGenderFilter = event.target.value;
                renderPlayersTable();
            });

            document.getElementById('filterClub').addEventListener('change', (event) => {
                selectedClubFilter = event.target.value;
                renderPlayersTable();
            });

            document.getElementById('filterName').addEventListener('input', (event) => {
                nameFilterValue = event.target.value || '';
                renderPlayersTable();
            });

            document.getElementById('playersBody').addEventListener('click', (event) => {
                const action = event.target?.dataset?.action;
                const playerId = event.target?.dataset?.id;
                if (!action || !playerId) return;
                if (action === 'edit') {
                    openEditForm(playerId);
                    return;
                }
                if (action === 'delete') {
                    removePlayer(playerId);
                }
            });
        }

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
