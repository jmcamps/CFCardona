<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Primer Equip | CF Cardona</title>
    <script src="../assets/js/top-nav.js" defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root{--primary:#d91d1d;--bg:#f1f5f9;--border:#e2e8f0;}
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Inter',sans-serif;}
        body{background:var(--bg);min-height:100vh;padding:2rem;overflow-x:auto;}
.card{background:white;border-radius:1rem;padding:2rem;box-shadow:0 4px 6px -1px rgb(0 0 0/0.1);border:1px solid var(--border);max-width:960px;margin:0 auto 2rem;position:relative;z-index:1;}
        .card h2{color:var(--primary);font-size:1.1rem;font-weight:800;margin-bottom:1.5rem;border-bottom:2px solid #fee2e2;padding-bottom:0.75rem;}
        label{display:block;font-weight:700;font-size:0.82rem;color:#475569;margin-bottom:0.4rem;text-transform:uppercase;letter-spacing:0.05em;}
        textarea{width:100%;min-height:120px;padding:0.75rem;border:1px solid var(--border);border-radius:0.5rem;font-size:0.9rem;outline:none;resize:vertical;line-height:1.6;}
        textarea:focus{border-color:var(--primary);}
        input[type=text],input[type=tel],input[type=date],input[type=time],input[type=url]{width:100%;padding:0.6rem 0.8rem;border:1px solid var(--border);border-radius:0.5rem;font-size:0.9rem;outline:none;}
        input:focus,select:focus{border-color:var(--primary);}
        select{width:100%;padding:0.6rem 0.8rem;border:1px solid var(--border);border-radius:0.5rem;font-size:0.9rem;outline:none;background:white;}
        .horari-table{width:100%;border-collapse:collapse;font-size:0.88rem;}
        .horari-table thead tr{background:#fee2e2;color:var(--primary);}
        .horari-table th{padding:0.6rem 1rem;text-align:left;font-weight:700;}
        .horari-table td{padding:0.65rem 1rem;border-bottom:1px solid var(--border);}
        .horari-table tr:last-child td{border-bottom:none;}
        .dia-badge{font-weight:800;color:var(--primary);}
        .comp-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1.5rem;}
        .comp-link-box{background:#fff5f5;border:1px solid #fecaca;border-radius:0.75rem;padding:1.25rem;display:flex;flex-direction:column;gap:0.75rem;}
        .fed-link{display:inline-flex;align-items:center;gap:0.5rem;background:var(--primary);color:white;text-decoration:none;padding:0.6rem 1.2rem;border-radius:0.5rem;font-weight:700;font-size:0.85rem;width:fit-content;transition:all 0.2s;}
        .fed-link:hover{background:#b91c1c;}
        .partit-list{margin-bottom:1rem;}
        .partit-item{background:#fffafa;border:1px solid #fecaca;border-radius:0.75rem;padding:1rem 1.25rem;margin-bottom:0.75rem;display:flex;justify-content:space-between;align-items:flex-start;gap:1rem;}
        .partit-info{flex:1;}
        .partit-header{display:flex;align-items:center;gap:0.75rem;flex-wrap:wrap;margin-bottom:0.3rem;}
        .partit-date{font-weight:800;color:var(--primary);}
        .type-amisto{background:#dbeafe;color:#1d4ed8;font-size:0.75rem;font-weight:700;padding:0.2rem 0.6rem;border-radius:1rem;}
        .type-torneig{background:#fef9c3;color:#854d0e;font-size:0.75rem;font-weight:700;padding:0.2rem 0.6rem;border-radius:1rem;}
        .partit-rival{font-weight:700;}
        .partit-lloc{font-size:0.82rem;color:#64748b;}
        .partit-result{font-size:0.82rem;color:#475569;}
        .add-form-box{background:#f8fafc;border:1px solid var(--border);border-radius:0.75rem;padding:1.25rem;}
        .add-form-title{font-size:0.82rem;font-weight:800;text-transform:uppercase;color:#475569;margin-bottom:1rem;}
        .form-row-4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:0.75rem;margin-bottom:0.75rem;}
        .form-row-3{display:grid;grid-template-columns:1fr 1fr auto;gap:0.75rem;margin-bottom:0.75rem;}
        .plantilla-table{width:100%;border-collapse:collapse;font-size:0.88rem;}
        .plantilla-table thead tr{background:#fee2e2;color:var(--primary);}
        .plantilla-table th{padding:0.6rem 0.75rem;text-align:left;font-weight:700;}
        .plantilla-table td{padding:0.6rem 0.75rem;border-bottom:1px solid var(--border);vertical-align:middle;}
        .plantilla-table td input[type=text],
        .plantilla-table td input[type=number]{margin:0;}
        .plantilla-table td input[type=checkbox]{width:auto;}
        .plantilla-actions{width:220px;text-align:right;white-space:nowrap;}
        .obs-list{margin-bottom:1rem;}
        .obs-item{background:#fffafa;border:1px solid #fecaca;border-radius:0.75rem;padding:1rem 1.25rem;margin-bottom:0.75rem;}
        .obs-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;}
        .obs-meta{font-size:0.82rem;color:#64748b;}
        .obs-meta strong{color:var(--primary);}
        .obs-text{font-size:0.9rem;line-height:1.6;white-space:pre-wrap;}
        .add-obs-form{background:#f8fafc;border:1px solid var(--border);border-radius:0.75rem;padding:1.25rem;}
        .form-title{font-size:0.82rem;font-weight:800;text-transform:uppercase;color:#475569;margin-bottom:1rem;}
        .obs-form-row{display:grid;grid-template-columns:1fr 1fr auto;gap:0.75rem;margin-bottom:0.75rem;align-items:end;}
        .btn{padding:0.65rem 1.5rem;border-radius:0.5rem;font-weight:700;cursor:pointer;border:none;font-size:0.88rem;}
        .btn-primary{background:var(--primary);color:white;}
        .btn-primary:hover{background:#b91c1c;}
        .btn-edit{margin-right:0.5rem;vertical-align:middle;font-size:0.75rem;padding:0.4rem 0.8rem;}
        .btn-remove{background:none;border:none;color:var(--primary);font-size:1.2rem;cursor:pointer;padding:0 0.25rem;}
        .empty-msg{color:#94a3b8;font-size:0.85rem;padding:0.5rem;}
        
        @media(max-width:640px){
            .comp-grid,.form-row-4,.form-row-3{grid-template-columns:1fr;}
            .horari-form-row{grid-template-columns:1fr 1fr;}
            .obs-form-row{grid-template-columns:1fr;}
        }
    </style>
</head>
<body>
<div class="card">
        <h2>&#x1F91D; Staff</h2>
        <div style="overflow-x:auto;">
            <table class="plantilla-table">
                <thead>
                    <tr>
                        <th>Rol</th>
                        <th>Nom i Cognoms</th>
                        <th>Telèfon</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="dia-badge">Primer Entrenador</td>
                        <td><input type="text" id="s_primer_entrenador_nom" placeholder="Nom..." onchange="saveAll(true)"></td>
                        <td><input type="tel" id="s_primer_entrenador_tel" placeholder="Telèfon..." onchange="saveAll(true)"></td>
                    </tr>
                    <tr>
                        <td class="dia-badge">Segon Entrenador</td>
                        <td><input type="text" id="s_segon_entrenador_nom" placeholder="Nom..." onchange="saveAll(true)"></td>
                        <td><input type="tel" id="s_segon_entrenador_tel" placeholder="Telèfon..." onchange="saveAll(true)"></td>
                    </tr>
                    <tr>
                        <td class="dia-badge">Preparador Físic</td>
                        <td><input type="text" id="s_preparador_fisic_nom" placeholder="Nom..." onchange="saveAll(true)"></td>
                        <td><input type="tel" id="s_preparador_fisic_tel" placeholder="Telèfon..." onchange="saveAll(true)"></td>
                    </tr>
                    <tr>
                        <td class="dia-badge">Delegat</td>
                        <td><input type="text" id="s_delegat_nom" placeholder="Nom..." onchange="saveAll(true)"></td>
                        <td><input type="tel" id="s_delegat_tel" placeholder="Telèfon..." onchange="saveAll(true)"></td>
                    </tr>
                    <tr>
                        <td class="dia-badge">Fisioterapeuta</td>
                        <td><input type="text" id="s_fisioterapeuta_nom" placeholder="Nom..." onchange="saveAll(true)"></td>
                        <td><input type="tel" id="s_fisioterapeuta_tel" placeholder="Telèfon..." onchange="saveAll(true)"></td>
                    </tr>
                    <tr>
                        <td class="dia-badge">Analista Tàctic</td>
                        <td><input type="text" id="s_analista_tactic_nom" placeholder="Nom..." onchange="saveAll(true)"></td>
                        <td><input type="tel" id="s_analista_tactic_tel" placeholder="Telèfon..." onchange="saveAll(true)"></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div class="card">
        <h2 id="plantilla_title">&#x1F4CB; Plantilla de Jugadors (0)</h2>
        <div style="overflow-x:auto;">
            <table class="plantilla-table">
                <thead>
                    <tr>
                        <th>Jugador</th>
                        <th>Posició</th>
                        <th class="plantilla-actions"></th>
                    </tr>
                </thead>
                <tbody id="player-list-tbody">
                    <!-- Player items will be injected here by JavaScript -->
                </tbody>
            </table>
        </div>
        <div style="margin-top:1rem; display:flex; justify-content:flex-end;">
            <a href="jugador-detall.html?mode=create&equipId=1" class="fed-link" style="font-size:0.75rem; padding:0.45rem 0.9rem;">+ AFEGIR JUGADOR</a>
        </div>
    </div>
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem; border-bottom:2px solid #fee2e2; padding-bottom:0.75rem;">
            <h2 style="margin-bottom:0; border-bottom:none; padding-bottom:0;">&#x1F5D3; Horari d'Entrenaments</h2>
            <a href="horari-entrenaments.html" class="fed-link" style="font-size:0.75rem; padding:0.4rem 0.8rem;">GESTIONAR HORARIS</a>
        </div>
        <div id="horari_list" class="empty-msg">Sense sessions registrades.</div>
    </div>
    <div class="card">
        <h2>&#x1F3C6; Competició</h2>
        <div class="comp-grid">
            <div><label>Categoria / Grup</label><input type="text" id="comp_categoria" placeholder="Ex: Quarta Catalana Grup 17" onchange="saveAll(true)"></div>
            <div><label>Temporada</label><input type="text" id="comp_temporada" placeholder="Ex: 2024-2025" onchange="saveAll(true)"></div>
        </div>
        <div class="comp-link-box">
            <div><label>Enllaç Federació Catalana de Futbol</label><input type="url" id="comp_url" placeholder="https://www.fcf.cat/..." onchange="saveAll(true)"></div>
            <div><a id="comp_link_btn" href="#" target="_blank" class="fed-link" onclick="openFedLink(event)">&#x1F517; Obrir classificació a la FCF</a></div>
        </div>
    </div>
    <div class="card">
        <h2>&#x1F4C5; Partits Amistosos i Tornejos</h2>
        <div id="partits_list" class="partit-list"><div class="empty-msg">Sense partits registrats.</div></div>
        <div class="add-form-box">
            <div class="add-form-title">Afegir Partit / Torneig</div>
            <div class="form-row-4">
                <div><label>Data</label><input type="date" id="p_data"></div>
                <div><label>Tipus</label><select id="p_tipus"><option value="Amistós">Amistós</option><option value="Torneig">Torneig</option></select></div>
                <div><label>Rival</label><input type="text" id="p_rival" placeholder="Nom del rival..."></div>
                <div><label>Lloc</label><select id="p_lloc"><option value="Casa">Casa</option><option value="Fora">Fora</option><option value="Neutral">Neutral</option></select></div>
            </div>
            <div class="form-row-3">
                <div><label>Resultat (opcional)</label><input type="text" id="p_resultat" placeholder="Ex: 2-1"></div>
                <div><label>Nom torneig (si escau)</label><input type="text" id="p_torneig" placeholder="Ex: Torneig Festa Major"></div>
                <div style="display:flex;align-items:flex-end;"><button class="btn btn-primary" style="width:100%;" onclick="addPartit()">AFEGIR PARTIT</button></div>
            </div>
        </div>
    </div>
    <div class="card">
        <h2>&#x1F4AC; Observacions i Comentaris</h2>
        <div id="obs_list" class="obs-list"><div class="empty-msg">Sense observacions registrades.</div></div>
        <div class="add-obs-form">
            <div class="form-title">Nou Comentari</div>
            <div class="obs-form-row">
                <div><label>Autor</label><input type="text" id="obs_autor" placeholder="Qui fa el comentari..."></div>
                <div><label>Data</label><input type="date" id="obs_data"></div>
                <div><button class="btn btn-primary" onclick="addObs()">AFEGIR</button></div>
            </div>
            <div><label>Comentari</label><textarea id="obs_text" style="min-height:100px;" placeholder="Escriu el comentari..."></textarea></div>
        </div>
    </div>
    <script>
        const API = '/api/players';
        const KEY = 'seccio_primer-equip';
        const STORAGE_KEY = `${KEY}_local`;
        const IS_FILE = window.location.protocol === 'file:';
        const API_JUGADORS = '/api/jugadors';
        const API_EQUIP_CONFIG = '/api/equip-config';
        const API_HORARIOS = '/api/horarios';
        const EQUIP_ID = 1;

        let db = {}, observacions = [], horaris = [], partits = [], plantilla = [];
        const SF = ["s_primer_entrenador_nom", "s_primer_entrenador_tel", "s_segon_entrenador_nom", "s_segon_entrenador_tel", "s_preparador_fisic_nom", "s_preparador_fisic_tel", "s_delegat_nom", "s_delegat_tel", "s_fisioterapeuta_nom", "s_fisioterapeuta_tel", "s_analista_tactic_nom", "s_analista_tactic_tel"];
        
        function renderPlantilla() {
            const tbody = document.getElementById('player-list-tbody');
            if (!tbody) return;
            const plantillaTitle = document.getElementById('plantilla_title');
            if (plantillaTitle) plantillaTitle.innerHTML = '&#x1F4CB; Plantilla de Jugadors (' + (Array.isArray(plantilla) ? plantilla.length : 0) + ')';

            if (!plantilla || plantilla.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="empty-msg">No hi ha jugadors registrats per a aquest equip.</td></tr>';
                return;
            }

            plantilla.sort((a, b) => (a.nom || '').localeCompare(b.nom || ''));

            tbody.innerHTML = plantilla.map(player => {
                const playerId = encodeURIComponent(String(player.id || ''));
                return `
                    <tr>
                        <td>${player.nom || 'N/A'}</td>
                        <td>${player.posicio || 'N/A'}</td>
                        <td class="plantilla-actions">
                            <a href="jugador-detall.html?playerId=${playerId}" class="fed-link btn-edit">VEURE DETALLS</a>
                            <button class="btn-remove" onclick="removePlayer(${Number(player.id)||0})" title="Eliminar jugador">&#x00D7;</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function removePlayer(playerId) {
            const selectedPlayer = Array.isArray(plantilla) ? plantilla.find(p => Number(p.id) === Number(playerId)) : null;
            const playerName = selectedPlayer && selectedPlayer.nom ? selectedPlayer.nom : `ID ${playerId}`;
            if (!confirm(`Segur que vols eliminar el jugador "${playerName}" de la base de dades? Aquesta acció no es pot desfer.`)) {
                return;
            }

            if (IS_FILE) {
                console.log("L'eliminació no està permesa en mode local (file://).");
                alert("L'eliminació només funciona quan l'aplicació s'executa des del servidor.");
                return;
            }

            try {
                const response = await fetch(`${API_JUGADORS}?id=${playerId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Error en eliminar el jugador.');
                }

                console.log('Jugador eliminat correctament.');
                // Tornem a carregar les dades per refrescar la llista
                await load();

            } catch (e) {
                console.error('Error en el procés d\'eliminació:', e);
                alert(`No s'ha pogut eliminar el jugador: ${e.message}`);
            }
        }

        function loadFromStorage() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                return raw ? JSON.parse(raw) : {};
            } catch (e) {
                return {};
            }
        }

        function saveToStorage() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
            } catch (e) {
                console.warn('No es pot guardar a localStorage');
            }
        }

        async function load() {
            try {
                if (!IS_FILE) {
                    const [dbRes, equipConfigRes, horarisRes, jugadorsRes] = await Promise.all([
                        fetch(API),
                        fetch(`${API_EQUIP_CONFIG}?equipId=${EQUIP_ID}`),
                        fetch(API_HORARIOS),
                        fetch(`${API_JUGADORS}?equipId=${EQUIP_ID}`)
                    ]);

                    if (!dbRes.ok) throw new Error(`Error carregant DB: ${dbRes.statusText}`);
                    db = await dbRes.json();

                    if (!equipConfigRes.ok) throw new Error(`Error carregant Equip Config: ${equipConfigRes.statusText}`);
                    const equipConfig = await equipConfigRes.json();
                    
                    if (!horarisRes.ok) throw new Error(`Error carregant Horaris: ${horarisRes.statusText}`);
                    const allHoraris = await horarisRes.json();
                    horaris = Array.isArray(allHoraris) ? allHoraris.filter(h => String(h.team_id || h.equip_id || '') === String(EQUIP_ID)) : [];

                    if (!jugadorsRes.ok) throw new Error(`Error carregant Jugadors: ${jugadorsRes.statusText}`);
                    plantilla = await jugadorsRes.json();

                    const d = db[KEY] || {};
                    SF.forEach(f => { const el = document.getElementById(f); if (el) el.value = equipConfig[f] || d[f] || ''; });
                    ['comp_categoria', 'comp_temporada', 'comp_url'].forEach(f => {
                        const el = document.getElementById(f); if (el) el.value = equipConfig[f] || d[f] || '';
                    });
                    partits = d.partits || []; 
                    observacions = d.observacions || [];

                } else {
                    db = loadFromStorage();
                    const d = db[KEY] || {};
                    SF.forEach(f => { const el = document.getElementById(f); if (el) el.value = d[f] || ''; });
                    ['comp_categoria', 'comp_temporada', 'comp_url'].forEach(f => {
                        const el = document.getElementById(f); if (el) el.value = d[f] || '';
                    });
                    horaris = d.horaris || []; 
                    partits = d.partits || []; 
                    observacions = d.observacions || [];
                    plantilla = d.plantilla || []; // En mode local, carreguem la plantilla del fitxer JSON
                }
                
                renderHorari(); 
                renderPartits(); 
                renderObs(); 
                renderPlantilla();

            } catch (e) {
                console.warn('Servidor no disponible o error en la càrrega:', e);
                alert(`Error carregant les dades: ${e.message}`);
                if (IS_FILE) {
                    db = loadFromStorage();
                    const d = db[KEY] || {};
                    horaris = d.horaris || []; partits = d.partits || []; observacions = d.observacions || []; plantilla = d.plantilla || [];
                    renderHorari(); renderPartits(); renderObs(); renderPlantilla();
                }
            }
        }

        async function saveAll(silent = false) {
            db[KEY] = { horaris, partits, observacions };
            SF.forEach(f => { const el = document.getElementById(f); if (el) db[KEY][f] = el.value; });
            ['comp_categoria', 'comp_temporada', 'comp_url'].forEach(f => {
                const el = document.getElementById(f); if (el) db[KEY][f] = el.value;
            });
            if (IS_FILE) {
                saveToStorage();
                if (!silent) console.log('Guardat automàtic correcte');
                return;
            }
            try {
                const equipPayload = {};
                SF.forEach(f => { equipPayload[f] = (document.getElementById(f) || {}).value || '' });
                ['comp_categoria', 'comp_temporada', 'comp_url'].forEach(f => { equipPayload[f] = (document.getElementById(f) || {}).value || '' });

                const [dbSaveRes, equipConfigSaveRes] = await Promise.all([
                    fetch(API, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(db) }),
                    fetch(`${API_EQUIP_CONFIG}?equipId=${EQUIP_ID}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(equipPayload) })
                ]);

                if (!dbSaveRes.ok) throw new Error(`Error desant a DB: ${dbSaveRes.statusText}`);
                if (!equipConfigSaveRes.ok) throw new Error(`Error desant a Equip Config: ${equipConfigSaveRes.statusText}`);

                if (!silent) console.log('Guardat automàtic correcte');
            } catch (e) { console.error('Error en el guardat automàtic', e); }
        }

        window.openFedLink = function (e) {
            const url = document.getElementById('comp_url') ? document.getElementById('comp_url').value.trim() : '';
            if (!url) { e.preventDefault(); alert("Introdueix primer l'enllaç de la FCF."); return; }
            document.getElementById('comp_link_btn').href = url;
        };

        function renderHorari() {
            const el = document.getElementById('horari_list'); if (!el) return;
            if (!horaris.length) { el.innerHTML = '<div class="empty-msg">Sense sessions registrades.</div>'; return; }
            
            const ordreDies=['Dilluns','Dimarts','Dimecres','Dijous','Divendres','Dissabte','Diumenge'];
            const sessions = [...horaris].sort((a,b) => {
                const diaA = ordreDies.indexOf(a.dia || '');
                const diaB = ordreDies.indexOf(b.dia || '');
                if (diaA !== diaB) return diaA - diaB;
                return (a.inici || '').localeCompare(b.inici || '');
            });

            el.innerHTML = '<table class="horari-table"><thead><tr><th>Dia</th><th>Inici</th><th>Fi</th><th>Vestidor</th><th>Camp</th></tr></thead><tbody>'
                + sessions.map((h) => '<tr><td class="dia-badge">' + h.dia + '</td><td>' + (h.inici || '-') + '</td><td>' + (h.fi || '-') + '</td><td>' + (esc(h.vestidor) || '-') + '</td><td>' + (esc(h.camp) || '-') + '</td></tr>').join('')
                + '</tbody></table>';
        }

        window.addPartit = async function () {
            const rival = document.getElementById('p_rival').value.trim();
            if (!rival) { alert('Introdueix el nom del rival.'); return; }
            partits.push({
                data: document.getElementById('p_data').value, tipus: document.getElementById('p_tipus').value,
                rival, lloc: document.getElementById('p_lloc').value,
                resultat: document.getElementById('p_resultat').value, torneig: document.getElementById('p_torneig').value
            });
            partits.sort((a, b) => a.data.localeCompare(b.data));
            ['p_data', 'p_rival', 'p_resultat', 'p_torneig'].forEach(id => document.getElementById(id).value = '');
            renderPartits();
            await saveAll(true);
        };
        window.removePartit = async function (i) {
            if (!confirm('Segur que vols eliminar aquest partit?')) return;
            partits.splice(i, 1);
            renderPartits();
            await saveAll(true);
        };
        function renderPartits() {
            const el = document.getElementById('partits_list'); if (!el) return;
            if (!partits.length) { el.innerHTML = '<div class="empty-msg">Sense partits registrats.</div>'; return; }
            el.innerHTML = partits.map((p, i) => {
                const tc = p.tipus === 'Torneig' ? 'type-torneig' : 'type-amisto';
                const tt = p.torneig ? ' &mdash; <em>' + esc(p.torneig) + '</em>' : '';
                const rt = p.resultat ? '<div class="partit-result">Resultat: <strong>' + esc(p.resultat) + '</strong></div>' : '';
                return '<div class="partit-item"><div class="partit-info"><div class="partit-header"><span class="partit-date">' + fmtDate(p.data) + '</span><span class="' + tc + '">' + p.tipus + '</span><span class="partit-rival">vs ' + esc(p.rival) + '</span><span class="partit-lloc">' + p.lloc + tt + '</span></div>' + rt + '</div><button class="btn-remove" onclick="removePartit(' + i + ')">&#x00D7;</button></div>';
            }).join('');
        }

        const today = new Date().toISOString().split('T')[0];
        if (document.getElementById('obs_data')) document.getElementById('obs_data').value = today;
        window.addObs = async function () {
            const text = document.getElementById('obs_text').value.trim(); if (!text) return;
            observacions.unshift({
                autor: document.getElementById('obs_autor').value || 'Anònim',
                data: document.getElementById('obs_data').value, text
            });
            document.getElementById('obs_text').value = '';
            document.getElementById('obs_autor').value = '';
            document.getElementById('obs_data').value = today;
            renderObs();
            await saveAll(true);
        };
        window.removeObs = async function (i) {
            if (!confirm('Segur que vols eliminar aquest comentari?')) return;
            observacions.splice(i, 1);
            renderObs();
            await saveAll(true);
        };
        function renderObs() {
            const el = document.getElementById('obs_list'); if (!el) return;
            if (!observacions.length) { el.innerHTML = '<div class="empty-msg">Sense observacions registrades.</div>'; return; }
            el.innerHTML = observacions.map((o, i) => '<div class="obs-item"><div class="obs-header"><div class="obs-meta"><strong>' + esc(o.autor) + '</strong> &mdash; ' + fmtDate(o.data) + '</div><button class="btn-remove" onclick="removeObs(' + i + ')">&#x00D7;</button></div><div class="obs-text">' + esc(o.text) + '</div></div>').join('');
        }

        function fmtDate(d) { if (!d) return '-'; return new Date(d + 'T12:00:00').toLocaleDateString('ca-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }); }
        function esc(t) { if (t===null || t===undefined) return ''; return String(t).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }
        
        document.addEventListener('DOMContentLoaded', () => {
            load();
        });
    </script>
</body>
</html>

