<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juvenil Femení | CF Cardona</title>
    <script src="../assets/js/top-nav.js" defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root{--primary:#d91d1d;--bg:#f1f5f9;--border:#e2e8f0;}
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Inter',sans-serif;}
        body{background:var(--bg);min-height:100vh;padding:2rem;overflow-x:auto;}
.card{background:white;border-radius:1rem;padding:2rem;box-shadow:0 4px 6px -1px rgb(0 0 0/0.1);border:1px solid var(--border);max-width:960px;margin:0 auto 2rem;position:relative;z-index:1;}
        .card h2{color:var(--primary);font-size:1.1rem;font-weight:800;margin-bottom:1.5rem;border-bottom:2px solid #fee2e2;padding-bottom:0.75rem;}
        label{display:block;font-weight:700;font-size:0.82rem;color:#475569;margin-bottom:0.4rem;text-transform:uppercase;letter-spacing:0.05em;}
        textarea{width:100%;min-height:120px;padding:0.75rem;border:1px solid var(--border);border-radius:0.5rem;font-size:0.9rem;outline:none;resize:vertical;line-height:1.6;}
        textarea:focus{border-color:var(--primary);}
        input[type=text],input[type=tel],input[type=date],input[type=time],input[type=url]{width:100%;padding:0.6rem 0.8rem;border:1px solid var(--border);border-radius:0.5rem;font-size:0.9rem;outline:none;}
        input:focus,select:focus{border-color:var(--primary);}
        select{width:100%;padding:0.6rem 0.8rem;border:1px solid var(--border);border-radius:0.5rem;font-size:0.9rem;outline:none;background:white;}
        .staff-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1.25rem;}
        .staff-member{background:#fffafa;border:1px solid #fecaca;border-radius:0.75rem;padding:1.25rem;}
        .role-title{font-size:0.78rem;font-weight:800;text-transform:uppercase;letter-spacing:0.08em;color:var(--primary);margin-bottom:0.75rem;}
        .staff-fields{display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;}
        .horari-form{background:#f8fafc;border:1px solid var(--border);border-radius:0.75rem;padding:1.25rem;margin-top:1rem;}
        .horari-form-title{font-size:0.82rem;font-weight:800;text-transform:uppercase;color:#475569;margin-bottom:1rem;}
        .horari-form-row{display:grid;grid-template-columns:1.5fr 1fr 1fr 1fr 1fr auto;gap:0.6rem;align-items:end;}
        .horari-table{width:100%;border-collapse:collapse;font-size:0.88rem;}
        .horari-table thead tr{background:#fee2e2;color:var(--primary);}
        .horari-table th{padding:0.6rem 1rem;text-align:left;font-weight:700;}
        .horari-table td{padding:0.65rem 1rem;border-bottom:1px solid var(--border);}
        .horari-table tr:last-child td{border-bottom:none;}
        .dia-badge{font-weight:800;color:var(--primary);}
        .comp-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1.5rem;}
        .comp-link-box{background:#fff5f5;border:1px solid #fecaca;border-radius:0.75rem;padding:1.25rem;display:flex;flex-direction:column;gap:0.75rem;}
        .fed-link{display:inline-flex;align-items:center;gap:0.5rem;background:var(--primary);color:white;text-decoration:none;padding:0.6rem 1.2rem;border-radius:0.5rem;font-weight:700;font-size:0.85rem;width:fit-content;transition:all 0.2s;}
        .fed-link:hover{background:#b91c1c;}
        .partit-list{margin-bottom:1rem;}
        .partit-item{background:#fffafa;border:1px solid #fecaca;border-radius:0.75rem;padding:1rem 1.25rem;margin-bottom:0.75rem;display:flex;justify-content:space-between;align-items:flex-start;gap:1rem;}
        .partit-info{flex:1;}
        .partit-header{display:flex;align-items:center;gap:0.75rem;flex-wrap:wrap;margin-bottom:0.3rem;}
        .partit-date{font-weight:800;color:var(--primary);}
        .type-amisto{background:#dbeafe;color:#1d4ed8;font-size:0.75rem;font-weight:700;padding:0.2rem 0.6rem;border-radius:1rem;}
        .type-torneig{background:#fef9c3;color:#854d0e;font-size:0.75rem;font-weight:700;padding:0.2rem 0.6rem;border-radius:1rem;}
        .partit-rival{font-weight:700;}
        .partit-lloc{font-size:0.82rem;color:#64748b;}
        .partit-result{font-size:0.82rem;color:#475569;}
        .add-form-box{background:#f8fafc;border:1px solid var(--border);border-radius:0.75rem;padding:1.25rem;}
        .add-form-title{font-size:0.82rem;font-weight:800;text-transform:uppercase;color:#475569;margin-bottom:1rem;}
        .form-row-4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:0.75rem;margin-bottom:0.75rem;}
        .form-row-3{display:grid;grid-template-columns:1fr 1fr auto;gap:0.75rem;margin-bottom:0.75rem;}
        .plantilla-placeholder{text-align:center;padding:3rem 2rem;background:#f8fafc;border-radius:0.75rem;border:2px dashed var(--border);}
        .plantilla-placeholder span{font-size:2.5rem;display:block;margin-bottom:1rem;}
        .plantilla-placeholder p{color:#94a3b8;font-size:0.95rem;margin-bottom:0.5rem;}
        .obs-list{margin-bottom:1rem;}
        .obs-item{background:#fffafa;border:1px solid #fecaca;border-radius:0.75rem;padding:1rem 1.25rem;margin-bottom:0.75rem;}
        .obs-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;}
        .obs-meta{font-size:0.82rem;color:#64748b;}
        .obs-meta strong{color:var(--primary);}
        .obs-text{font-size:0.9rem;line-height:1.6;white-space:pre-wrap;}
        .add-obs-form{background:#f8fafc;border:1px solid var(--border);border-radius:0.75rem;padding:1.25rem;}
        .form-title{font-size:0.82rem;font-weight:800;text-transform:uppercase;color:#475569;margin-bottom:1rem;}
        .obs-form-row{display:grid;grid-template-columns:1fr 1fr auto;gap:0.75rem;margin-bottom:0.75rem;align-items:end;}
        .btn{padding:0.65rem 1.5rem;border-radius:0.5rem;font-weight:700;cursor:pointer;border:none;font-size:0.88rem;}
        .btn-primary{background:var(--primary);color:white;}
        .btn-primary:hover{background:#b91c1c;}
        .btn-save-main{background:var(--primary);color:white;border:none;padding:0.75rem 2rem;border-radius:0.5rem;font-weight:700;cursor:pointer;font-size:0.95rem;}
        .plantilla-table{width:100%;border-collapse:collapse;font-size:0.88rem;}
        .plantilla-table thead tr{background:#fee2e2;color:var(--primary);}
        .plantilla-table th{padding:0.6rem 0.75rem;text-align:left;font-weight:700;}
        .plantilla-table td{padding:0.6rem 0.75rem;border-bottom:1px solid var(--border);vertical-align:middle;}
        .plantilla-table td input[type=text],
        .plantilla-table td input[type=date]{margin:0;}
        .plantilla-table td input[type=checkbox]{width:auto;}
        .plantilla-actions{width:40px;text-align:right;}
        .btn-remove{background:none;border:none;color:var(--primary);font-size:1.2rem;cursor:pointer;padding:0 0.25rem;}
        .empty-msg{color:#94a3b8;font-size:0.85rem;padding:0.5rem;}
        .alert-banner{max-width:960px;margin:0 auto 1.5rem;background:#fff1f2;border:1px solid #fecaca;color:#b91c1c;border-radius:0.75rem;padding:0.9rem 1.1rem;font-weight:800;display:none;align-items:center;gap:0.6rem;box-shadow:0 4px 10px rgba(185,28,28,0.12);}
        .alert-banner span{font-size:1.1rem;}
        .coord-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem;}
.link-card p{color:#64748b;font-size:0.9rem;margin-bottom:1.2rem;}
.tree{display:flex;flex-direction:column;align-items:center;padding:1rem 0;min-width:max-content;margin:0 auto;}
        
        /* Scouting Styles */
        .scouting-container { display: flex; gap: 2rem; align-items: flex-start; }
        .scouting-sidebar { width: 350px; flex-shrink: 0; background: white; border-radius: 1rem; border: 1px solid var(--border); padding: 1.5rem; max-height: 800px; overflow-y: auto; }
        .scouting-content { flex: 1; min-width: 0; }
        
        .scouting-list { display: grid; gap: 0.75rem; }
        .scouting-list-item { padding: 1rem; background: #fffafa; border: 1px solid #fecaca; border-radius: 0.75rem; cursor: pointer; transition: all 0.2s; position: relative; }
        .scouting-list-item:hover { transform: translateX(5px); background: #fee2e2; }
        .scouting-list-item.active { border-left: 5px solid var(--primary); background: #fee2e2; }
        .scouting-list-name { font-weight: 800; color: var(--primary); font-size: 1rem; }
        .scouting-list-meta { font-size: 0.75rem; color: #64748b; margin-top: 0.2rem; }

        .scouting-detail-card { background: white; border-radius: 1rem; padding: 2rem; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgb(0 0 0/0.1); }
        .scouting-header-actions { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; border-bottom: 2px solid #fee2e2; padding-bottom: 1rem; }
        .scouting-header-actions h2 { margin: 0; border: none; padding: 0; }
        
        .contact-item { background: white; border: 1px solid #e2e8f0; padding: 0.8rem 1rem; border-radius: 0.5rem; font-size: 0.85rem; display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem; margin-bottom: 0.5rem; }
        .contact-content { flex: 1; }
        .contact-meta { font-weight: 700; color: var(--primary); font-size: 0.75rem; text-transform: uppercase; margin-bottom: 0.25rem; display: block; }
        .btn-delete-small { color: #94a3b8; background: none; border: none; cursor: pointer; padding: 0.2rem; font-size: 1rem; }
        .btn-delete-small:hover { color: var(--primary); }

        .pos-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 0.5rem; padding: 0.5rem; background: #fff5f5; border: 1px solid #fecaca; border-radius: 0.5rem; margin-top: 0.4rem; }
        .pos-item { display: flex; align-items: center; gap: 0.5rem; font-size: 0.8rem; font-weight: 600; cursor: pointer; }
        .pos-item input { width: auto; }
        .scouting-form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem; }

        .v-line{width:2px;height:20px;background:#fca5a5;margin:0 auto;}
        .children-row{display:flex;gap:2rem;justify-content:center;position:relative;}
        .children-row::before{content:'';position:absolute;top:0;left:50%;transform:translateX(-50%);height:2px;background:#fca5a5;width:calc(100% - 60px);}
        .child-col{display:flex;flex-direction:column;align-items:center;}
        .tree-node{display:inline-flex;align-items:center;justify-content:center;padding:0.6rem 1.4rem;border-radius:0.5rem;font-weight:700;font-size:0.85rem;text-decoration:none;color:var(--primary);background:white;border:2px solid var(--primary);box-shadow:0 2px 8px rgba(217,29,29,0.1);transition:all 0.2s;white-space:nowrap;}
        .tree-node:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(217,29,29,0.2);background:#fff5f5;}
        .tree-node.root{background:#fee2e2;}
        @media(max-width:640px){.staff-fields,.comp-grid,.form-row-4,.form-row-3,.coord-grid{grid-template-columns:1fr;}.horari-form-row{grid-template-columns:1fr 1fr;}.obs-form-row{grid-template-columns:1fr;}}
    </style>
</head>
<body>
<div id="plantilla_alert" class="alert-banner"><span>&#x26A0;&#xFE0F;</span><div id="plantilla_alert_text"></div></div>
    <div id="staff_alert" class="alert-banner"><span>&#x26A0;&#xFE0F;</span><div id="staff_alert_text"></div></div>
    <div class="card">
        <h2>&#x1F91D; Staff</h2>
        <div style="overflow-x:auto;">
            <table class="plantilla-table">
                <thead>
                    <tr>
                        <th>Rol</th>
                        <th>Nom i Cognoms</th>
                        <th>Telèfon</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="dia-badge">Primer Entrenador</td>
                        <td><input type="text" id="s_primer_entrenador_nom" placeholder="Nom..." onchange="saveAll(true)"></td>
                        <td><input type="tel" id="s_primer_entrenador_tel" placeholder="Telèfon..." onchange="saveAll(true)"></td>
                    </tr>
                    <tr>
                        <td class="dia-badge">Segon Entrenador</td>
                        <td><input type="text" id="s_segon_entrenador_nom" placeholder="Nom..." onchange="saveAll(true)"></td>
                        <td><input type="tel" id="s_segon_entrenador_tel" placeholder="Telèfon..." onchange="saveAll(true)"></td>
                    </tr>
                    <tr>
                        <td class="dia-badge">Tercer Entrenador</td>
                        <td><input type="text" id="s_tercer_entrenador_nom" placeholder="Nom..." onchange="saveAll(true)"></td>
                        <td><input type="tel" id="s_tercer_entrenador_tel" placeholder="Telèfon..." onchange="saveAll(true)"></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div class="card">
        <h2 id="plantilla_title">&#x1F4CB; Plantilla de Jugadores (0)</h2>
        <div style="overflow-x:auto;">
            <table class="plantilla-table">
                <thead>
                    <tr>
                        <th>Jugadora</th>
                        <th>Any de naixement</th>
                        <th style="text-align:center;">Revisi&oacute; m&egrave;dica</th>
                        <th style="text-align:center;">Inscripció</th>
                        <th style="text-align:center;">Pagament FCF</th>
                        <th style="text-align:center;">Vinculat al club</th>
                        <th class="plantilla-actions"></th>
                    </tr>
                </thead>
                <tbody id="plantilla_tbody"></tbody>
            </table>
        </div>
        <div style="margin-top:2rem;">
            <h3 id="captacio_title" style="color:#059669;font-size:0.95rem;font-weight:800;margin-bottom:1rem;border-bottom:2px solid #86efac;padding-bottom:0.5rem;">&#x1F31F; Suggeriments de Captació (Coincidència d'Edat i Gènere) (0)</h3>
            <div id="captacio_suggestions"></div>
        </div>
        <div class="add-form-box" style="margin-top:1rem;">
            <div class="add-form-title">Afegir Jugadora</div>
            <div class="form-row-4">
                <div><label>Nom i Cognoms</label><input type="text" id="p_nom" placeholder="Nom..."></div>
                <div><label>Any de naixement</label><input type="number" id="p_naixement" min="1990" max="2030" placeholder="Ex: 2009"></div>
                <div><label>Revisi&oacute; m&egrave;dica</label><input type="checkbox" id="p_revisio"></div>
                <div><label>Inscripció</label><input type="checkbox" id="p_inscripcio"></div>
            </div>
            <div class="form-row-3" style="margin-bottom:0;">
                <div><label>Pagament FCF</label><input type="checkbox" id="p_pagament_fcf"></div>
                <div><label>Vinculat al club</label><input type="checkbox" id="p_vinculat_club"></div>
                <div></div>
            </div>
            <div style="display:flex;justify-content:flex-end;">
                <button class="btn btn-primary" onclick="addPlayer()">AFEGIR JUGADORA</button>
            </div>
        </div>
    </div>
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem; border-bottom:2px solid #fee2e2; padding-bottom:0.75rem;">
            <h2 style="margin-bottom:0; border-bottom:none; padding-bottom:0;">&#x1F5D3; Horari d&apos;Entrenaments</h2>
            <a href="horari-entrenaments.html" class="fed-link" style="font-size:0.75rem; padding:0.4rem 0.8rem;">GESTIONAR HORARIS</a>
        </div>
        <div id="horari_list" class="empty-msg">Sense sessions registrades.</div>
    </div>
    <div class="card">
        <h2>&#x1F3C6; Competici&oacute;</h2>
        <div class="comp-grid">
            <div><label>Categoria / Grup</label><input type="text" id="comp_categoria" placeholder="Ex: Quarta Catalana Grup 17" onchange="saveAll(true)"></div>
            <div><label>Temporada</label><input type="text" id="comp_temporada" placeholder="Ex: 2024-2025" onchange="saveAll(true)"></div>
        </div>
        <div class="comp-link-box">
            <div><label>Enlla&ccedil; Federaci&oacute; Catalana de Futbol</label><input type="url" id="comp_url" placeholder="https://www.fcf.cat/..." onchange="saveAll(true)"></div>
            <div><a id="comp_link_btn" href="#" target="_blank" class="fed-link" onclick="openFedLink(event)">&#x1F517; Obrir classificaci&oacute; a la FCF</a></div>
        </div>
    </div>
    <div class="card">
        <h2>&#x1F4C5; Partits Amistosos i Tornejos</h2>
        <div id="partits_list" class="partit-list"><div class="empty-msg">Sense partits registrats.</div></div>
        <div class="add-form-box">
            <div class="add-form-title">Afegir Partit / Torneig</div>
            <div class="form-row-4">
                <div><label>Data</label><input type="date" id="p_data"></div>
                <div><label>Tipus</label><select id="p_tipus"><option value="Amistós">Amistós</option><option value="Torneig">Torneig</option></select></div>
                <div><label>Rival</label><input type="text" id="p_rival" placeholder="Nom del rival..."></div>
                <div><label>Lloc</label><select id="p_lloc"><option value="Casa">Casa</option><option value="Fora">Fora</option><option value="Neutral">Neutral</option></select></div>
            </div>
            <div class="form-row-3">
                <div><label>Resultat (opcional)</label><input type="text" id="p_resultat" placeholder="Ex: 2-1"></div>
                <div><label>Nom torneig (si escau)</label><input type="text" id="p_torneig" placeholder="Ex: Torneig Festa Major"></div>
                <div style="display:flex;align-items:flex-end;"><button class="btn btn-primary" style="width:100%;" onclick="addPartit()">AFEGIR PARTIT</button></div>
            </div>
        </div>
    </div>
    <div class="card">
        <h2>&#x1F4AC; Observacions i Comentaris</h2>
        <div id="obs_list" class="obs-list"><div class="empty-msg">Sense observacions registrades.</div></div>
        <div class="add-obs-form">
            <div class="form-title">Nou Comentari</div>
            <div class="obs-form-row">
                <div><label>Autor</label><input type="text" id="obs_autor" placeholder="Qui fa el comentari..."></div>
                <div><label>Data</label><input type="date" id="obs_data"></div>
                <div><button class="btn btn-primary" onclick="addObs()">AFEGIR</button></div>
            </div>
            <div><label>Comentari</label><textarea id="obs_text" style="min-height:100px;" placeholder="Escriu el comentari..."></textarea></div>
        </div>
    </div>
    <script>
        const API='/api/players';
        const API_JUGADORS='/api/jugadors';
        const API_JUGADORS_SEGUIMENT='/api/jugadors-seguiment';
        const API_EQUIP_CONFIG='/api/equip-config';
        const API_HORARIOS='/api/horarios';
        const EQUIP_ID=17;
        const KEY='seccio_juvenil-femeni';
        const STORAGE_KEY=`${KEY}_local`;
        const IS_FILE=window.location.protocol==='file:';
        const TARGET_MIN_YEAR=2008;
        const TARGET_MAX_YEAR=2010;
        const TARGET_GENDER='Femení';
        const MIN_PLAYERS=14;
        const MIN_LABEL='Juvenil Femení';
        const DEFAULT_PLANTILLA=[
            {nom:'BADIA TORRES, IBETH', naixement:'19-10-2010', revisio:false},
            {nom:'COROMINAS BECH, ELIA', naixement:'17-07-2010', revisio:false},
            {nom:'ESQUIUS GARCIA, NÚRIA', naixement:'20-08-2010', revisio:false},
            {nom:'PEREZ RODRIGUEZ, LYDIA', naixement:'19-09-2010', revisio:false},
            {nom:'MASAS TORRENTS, ISIS', naixement:'10-11-2010', revisio:false},
            {nom:'GHAILAN BAZIOU, AYA', naixement:'09-04-2010', revisio:false},
            {nom:'CARDONA ESPLUGA, BRUNA', naixement:'07-01-2009', revisio:false},
            {nom:'ESTRUCH VALDIVIA, CRISTINA', naixement:'14-12-2009', revisio:false},
            {nom:'FONTAN SANCHEZ, JANA', naixement:'13-04-2009', revisio:false},
            {nom:'FREIXA FERNANDEZ, MARIA', naixement:'17-10-2009', revisio:false},
            {nom:'GONZALEZ TRISTANY, ANNA', naixement:'13-08-2009', revisio:false},
            {nom:'LARA CALLE, MARIA', naixement:'05-06-2009', revisio:false},
            {nom:'MASAS TORRENTS, IVET', naixement:'25-01-2009', revisio:false},
            {nom:'NAVAS DÍAZ-MADROÑERO, MARIONA', naixement:'26-12-2009', revisio:false},
            {nom:'NOVA GARCIA, JULIA', naixement:'24-11-2009', revisio:false},
            {nom:'TORRADAS HERNANDEZ, LAURA', naixement:'24-09-2009', revisio:false},
            {nom:'TRISTANY FERNANDEZ, BRUNA', naixement:'26-10-2008', revisio:false},
            {nom:'SANCHEZ PEREZ, CLOE', naixement:'26-09-2008', revisio:false},
            {nom:'RODRÍGUEZ FORTUNATO, ZAIRA', naixement:'09-10-2008', revisio:false}
        ];

        let db={},observacions=[],horaris=[],partits=[],plantilla=[],captacioSuggestions=[];
        const SF=["s_primer_entrenador_nom","s_primer_entrenador_tel","s_segon_entrenador_nom","s_segon_entrenador_tel","s_tercer_entrenador_nom","s_tercer_entrenador_tel"];

        function normalizeDate(value){
            if(!value) return '';
            if(/^\d{4}-\d{2}-\d{2}$/.test(value)) return value;
            if(/^\d{2}-\d{2}-\d{4}$/.test(value)){
                const parts=value.split('-');
                return `${parts[2]}-${parts[1]}-${parts[0]}`;
            }
            return '';
        }

        function normalizeGender(value){
            return String(value||'')
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g,'')
                .toLowerCase()
                .trim();
        }

        function normalizeBirthYear(value){
            if(value===null||value===undefined) return '';
            const raw=String(value).trim();
            if(!raw) return '';
            if(/^\d{4}$/.test(raw)) return raw;
            if(/^\d{4}-\d{2}-\d{2}$/.test(raw)) return raw.slice(0,4);
            if(/^\d{2}-\d{2}-\d{4}$/.test(raw)) return raw.slice(-4);
            return '';
        }

        function isValidBirthYear(yearValue){
            const yearText=normalizeBirthYear(yearValue);
            if(!yearText) return false;
            const year=Number(yearText);
            return Number.isInteger(year) && year>=1900 && year<=2100;
        }

        function isNumericId(value){
            return /^\d+$/.test(String(value||'').trim());
        }

        function toBool(value){
            if(typeof value==='boolean') return value;
            if(typeof value==='number') return value!==0;
            const text=String(value??'').trim().toLowerCase();
            if(!text) return false;
            if(['true','t','1','yes','si','sí'].includes(text)) return true;
            if(['false','f','0','no'].includes(text)) return false;
            return !!value;
        }

        function isHorariForEquip(horari){
            const rawId = horari && (horari.team_id ?? horari.equip_id ?? '');
            const id = String(rawId || '').trim();
            return id === String(EQUIP_ID);
        }

        function seedPlantilla(){
            return DEFAULT_PLANTILLA.map(p=>({
                nom:p.nom,
                naixement:normalizeBirthYear(p.naixement),
                revisio:!!p.revisio
            }));
        }

        function loadFromStorage(){
            try{
                const raw=localStorage.getItem(STORAGE_KEY);
                return raw?JSON.parse(raw):{};
            }catch(e){
                return {};
            }
        }

        function saveToStorage(){
            try{
                localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
            }catch(e){
                console.warn('No es pot guardar a localStorage');
            }
        }

        async function loadCaptacioSuggestions(){
            captacioSuggestions=[];
            if(IS_FILE) return;
            try{
                const r=await fetch(API_JUGADORS_SEGUIMENT);
                if(!r.ok){
                    const errorText=await r.text();
                    throw new Error(`GET jugadors-seguiment ${r.status}: ${errorText}`);
                }
                const players=await r.json();
                const targetGender=normalizeGender(TARGET_GENDER);
                captacioSuggestions=(Array.isArray(players)?players:[]).filter(p=>{
                    const year=Number(normalizeBirthYear(p.any_naixement ?? p.naixement ?? ''));
                    const yearMatch=Number.isFinite(year) && year>=TARGET_MIN_YEAR && year<=TARGET_MAX_YEAR;
                    const genderMatch=normalizeGender(p.genere)===targetGender;
                    return yearMatch && genderMatch;
                });
                captacioSuggestions.sort((a,b)=>String(a.nom||'').localeCompare(String(b.nom||'')));
            }catch(e){
                console.warn('Error carregant captació:',e);
            }
        }

        async function load(){
            try{
                if(!IS_FILE){
                    const r=await fetch(API);
                    if(!r.ok){
                        const errorText=await r.text();
                        throw new Error(`GET ${r.status}: ${errorText}`);
                    }
                    db=await r.json();
                }else{
                    db=loadFromStorage();
                }
                const d=db[KEY]||{};

                if(!IS_FILE){
                    const rc=await fetch(`${API_EQUIP_CONFIG}?equipId=${encodeURIComponent(EQUIP_ID)}`);
                    if(!rc.ok){
                        const errorText=await rc.text();
                        throw new Error(`GET equip-config ${rc.status}: ${errorText}`);
                    }
                    const cfg=await rc.json();
                    SF.forEach(f=>{const el=document.getElementById(f);if(el)el.value=cfg[f]||'';});
                    ['comp_categoria','comp_temporada','comp_url'].forEach(f=>{
                        const el=document.getElementById(f); if(el) el.value=cfg[f]||'';
                    });
                }else{
                    SF.forEach(f=>{const el=document.getElementById(f);if(el)el.value=d[f]||'';});
                    ['comp_categoria','comp_temporada','comp_url'].forEach(f=>{
                        const el=document.getElementById(f); if(el) el.value=d[f]||'';
                    });
                }

                partits=d.partits||[];
                observacions=d.observacions||[];

                if(!IS_FILE){
                    const rh=await fetch(API_HORARIOS);
                    if(!rh.ok){
                        const errorText=await rh.text();
                        throw new Error(`GET horarios ${rh.status}: ${errorText}`);
                    }
                    const allHoraris=await rh.json();
                    horaris=Array.isArray(allHoraris) ? allHoraris.filter(isHorariForEquip) : [];
                }else if(IS_FILE){
                    horaris=d.horaris||[];
                }else{
                    horaris=[];
                }

                if(!IS_FILE){
                    const rp=await fetch(`${API_JUGADORS}?equipId=${encodeURIComponent(EQUIP_ID)}`);
                    if(!rp.ok){
                        const errorText=await rp.text();
                        throw new Error(`GET jugadors ${rp.status}: ${errorText}`);
                    }
                    const jugadors=await rp.json();
                    plantilla=Array.isArray(jugadors)?jugadors.map(j=>({
                        id:j.id,
                        nom:j.nom||'',
                        naixement:normalizeBirthYear(j.any_naixement||j.naixement||''),
                        revisio:toBool(j.revisio),
                        inscripcio:toBool(j.inscripcio_feta ?? j.inscripcio),
                        pagament_fcf:toBool(j.pagament_fcf_fet ?? j.pagament_fcf),
                        vinculat_club:toBool(j.vinculat_club)
                    })):[];
                }else if(IS_FILE && Object.prototype.hasOwnProperty.call(d,'plantilla')){
                    plantilla=Array.isArray(d.plantilla)?d.plantilla:[];
                }else if(!IS_FILE){
                    plantilla=[];
                }else{
                    plantilla=seedPlantilla();
                }
            }catch(e){
                console.warn('Servidor no disponible');
                if(IS_FILE){
                    const d=db[KEY]||{};
                    horaris=d.horaris||[];
                    partits=d.partits||[];
                    observacions=d.observacions||[];
                    plantilla=Array.isArray(d.plantilla)?d.plantilla:seedPlantilla();
                }
            }
            renderHorari(); renderPartits(); renderObs(); renderPlantilla();
            await loadCaptacioSuggestions(); renderCaptacioSuggestions();
        }

        async function saveAll(silent = false){
            renderPlantilla();
            db[KEY]={horaris,partits,observacions};

            if(IS_FILE){
                db[KEY].plantilla=plantilla;
                SF.forEach(f=>{const el=document.getElementById(f);if(el)db[KEY][f]=el.value;});
                ['comp_categoria','comp_temporada','comp_url'].forEach(f=>{
                    const el=document.getElementById(f); if(el) db[KEY][f]=el.value;
                });
                saveToStorage();
                return;
            }

            try{
                const requests=[
                    fetch(API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(db)})
                ];

                const equipPayload={
                    s_primer_entrenador_nom:(document.getElementById('s_primer_entrenador_nom')||{}).value||'',
                    s_primer_entrenador_tel:(document.getElementById('s_primer_entrenador_tel')||{}).value||'',
                    s_segon_entrenador_nom:(document.getElementById('s_segon_entrenador_nom')||{}).value||'',
                    s_segon_entrenador_tel:(document.getElementById('s_segon_entrenador_tel')||{}).value||'',
                    s_tercer_entrenador_nom:(document.getElementById('s_tercer_entrenador_nom')||{}).value||'',
                    s_tercer_entrenador_tel:(document.getElementById('s_tercer_entrenador_tel')||{}).value||'',
                    comp_categoria:(document.getElementById('comp_categoria')||{}).value||'',
                    comp_temporada:(document.getElementById('comp_temporada')||{}).value||'',
                    comp_url:(document.getElementById('comp_url')||{}).value||''
                };
                requests.push(fetch(`${API_EQUIP_CONFIG}?equipId=${encodeURIComponent(EQUIP_ID)}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(equipPayload)}));

                const responses=await Promise.all(requests);
                if(!responses[0].ok){
                    const errorText=await responses[0].text();
                    throw new Error(`POST players ${responses[0].status}: ${errorText}`);
                }
                if(responses[1] && !responses[1].ok){
                    const errorText=await responses[1].text();
                    throw new Error(`POST equip-config ${responses[1].status}: ${errorText}`);
                }
                if(!silent) console.log('Guardat automàtic correcte');
            }catch(e){
                console.error('Error en el guardat automàtic:', e.message || e);
            }
        }

        window.openFedLink=function(e){
            const url=document.getElementById('comp_url')?document.getElementById('comp_url').value.trim():'';
            if(!url){e.preventDefault();alert("Introdueix primer l'enllaç de la FCF.");return;}
            document.getElementById('comp_link_btn').href=url;
        };

        function renderHorari(){
            const el=document.getElementById('horari_list'); if(!el)return;
            if(!horaris.length){el.innerHTML='<div class="empty-msg">Sense sessions registrades.</div>';return;}
            el.innerHTML='<table class="horari-table"><thead><tr><th>Dia</th><th>Inici</th><th>Fi</th><th>Vestidor</th><th>Camp</th></tr></thead><tbody>'
                +horaris.map((h,i)=>'<tr><td class="dia-badge">'+h.dia+'</td><td>'+(h.inici||'-')+'</td><td>'+(h.fi||'-')+'</td><td>'+(esc(h.vestidor)||'-')+'</td><td>'+(esc(h.camp)||'-')+'</td></tr>').join('')
                +'</tbody></table>';
        }

        window.addPartit=async function(){
            const rival=document.getElementById('p_rival').value.trim();
            if(!rival){alert('Introdueix el nom del rival.');return;}
            partits.push({data:document.getElementById('p_data').value,tipus:document.getElementById('p_tipus').value,
                rival,lloc:document.getElementById('p_lloc').value,
                resultat:document.getElementById('p_resultat').value,torneig:document.getElementById('p_torneig').value});
            partits.sort((a,b)=>a.data.localeCompare(b.data));
            ['p_data','p_rival','p_resultat','p_torneig'].forEach(id=>document.getElementById(id).value='');
            renderPartits();
            await saveAll(true);
        };
        window.removePartit=async function(i){
            if(!confirm('Segur que vols eliminar aquest partit?')) return;
            partits.splice(i,1);
            renderPartits();
            await saveAll(true);
        };
        function renderPartits(){
            const el=document.getElementById('partits_list'); if(!el)return;
            if(!partits.length){el.innerHTML='<div class="empty-msg">Sense partits registrats.</div>';return;}
            el.innerHTML=partits.map((p,i)=>{
                const tc=p.tipus==='Torneig'?'type-torneig':'type-amisto';
                const tt=p.torneig?' &mdash; <em>'+esc(p.torneig)+'</em>':'';
                const rt=p.resultat?'<div class="partit-result">Resultat: <strong>'+esc(p.resultat)+'</strong></div>':'';
                return '<div class="partit-item"><div class="partit-info"><div class="partit-header"><span class="partit-date">'+fmtDate(p.data)+'</span><span class="'+tc+'">'+p.tipus+'</span><span class="partit-rival">vs '+esc(p.rival)+'</span><span class="partit-lloc">'+p.lloc+tt+'</span></div>'+rt+'</div><button class="btn-remove" onclick="removePartit('+i+')">&#x00D7;</button></div>';
            }).join('');
        }

        function renderPlantilla(){
            const body=document.getElementById('plantilla_tbody');
            if(!body) return;
            const plantillaTitle=document.getElementById('plantilla_title');
            if(plantillaTitle){
                if(!plantillaTitle.dataset.baseTitle) plantillaTitle.dataset.baseTitle=plantillaTitle.innerHTML.replace(/\s*\(\d+\)\s*$/,'');
                plantillaTitle.innerHTML=plantillaTitle.dataset.baseTitle+' ('+plantilla.length+')';
            }
            const alertBox=document.getElementById('plantilla_alert');
            const alertText=document.getElementById('plantilla_alert_text');
            const staffAlert=document.getElementById('staff_alert');
            const staffAlertText=document.getElementById('staff_alert_text');
            if(alertBox && alertText){
                if(plantilla.length < MIN_PLAYERS){
                    alertText.textContent=`Equip amb ${plantilla.length} jugadores, el mínim recomanable son ${MIN_PLAYERS} jugadores per les plantilles de ${MIN_LABEL}!`;
                    alertBox.style.display='flex';
                }else{
                    alertBox.style.display='none';
                }
            }
            if(staffAlert && staffAlertText){
                const primerNom=(document.getElementById('s_primer_entrenador_nom')||{}).value||'';
                const segonNom=(document.getElementById('s_segon_entrenador_nom')||{}).value||'';
                const missing=[];
                if(!primerNom.trim()) missing.push('primer entrenador');
                if(!segonNom.trim()) missing.push('segon entrenador');
                if(missing.length){
                    staffAlertText.textContent=`Falta ${missing.join(' i ')} a l\'equip!`;
                    staffAlert.style.display='flex';
                }else{
                    staffAlert.style.display='none';
                }
            }
            if(!plantilla.length){
                body.innerHTML='<tr><td colspan="7" class="empty-msg">Sense jugadores registrades.</td></tr>';
                return;
            }
            body.innerHTML=plantilla.map((p,i)=>{
                const checkedRevisio=p.revisio?'checked':'';
                const checkedInscripcio=p.inscripcio?'checked':'';
                const checkedPagamentFcf=p.pagament_fcf?'checked':'';
                const checkedVinculatClub=p.vinculat_club?'checked':'';
                const d=normalizeBirthYear(p.naixement||'');
                return '<tr>'
                    +'<td><input type="text" value="'+esc(p.nom||'')+'" onchange="updatePlayer('+i+',\'nom\',this.value)"></td>'
                    +'<td><input type="number" min="1990" max="2030" value="'+d+'" onchange="updatePlayer('+i+',\'naixement\',this.value)"></td>'
                    +'<td style="text-align:center;"><input type="checkbox" '+checkedRevisio+' onchange="updatePlayer('+i+',\'revisio\',this.checked)"></td>'
                    +'<td style="text-align:center;"><input type="checkbox" '+checkedInscripcio+' onchange="updatePlayer('+i+',\'inscripcio\',this.checked)"></td>'
                    +'<td style="text-align:center;"><input type="checkbox" '+checkedPagamentFcf+' onchange="updatePlayer('+i+',\'pagament_fcf\',this.checked)"></td>'
                    +'<td style="text-align:center;"><input type="checkbox" '+checkedVinculatClub+' onchange="updatePlayer('+i+',\'vinculat_club\',this.checked)"></td>'
                    +'<td class="plantilla-actions"><button class="btn-remove" onclick="removePlayer('+i+')">&#x00D7;</button></td>'
                    +'</tr>';
            }).join('');
        }

        window.addPlayer=async function(){
            const nom=document.getElementById('p_nom').value.trim();
            const naixement=normalizeBirthYear(document.getElementById('p_naixement').value);
            const revisio=document.getElementById('p_revisio').checked;
            const inscripcio=document.getElementById('p_inscripcio').checked;
            const pagamentFcf=document.getElementById('p_pagament_fcf').checked;
            const vinculatClub=document.getElementById('p_vinculat_club').checked;
            if(!nom){alert('Introdueix el nom de la jugadora.');return;}
            if(!isValidBirthYear(naixement)){alert('Introdueix un any de naixement vàlid (format YYYY).');return;}

            if(IS_FILE){
                plantilla.push({id:`local_${Date.now()}`,nom,naixement,revisio,inscripcio,pagament_fcf:pagamentFcf,vinculat_club:vinculatClub});
                document.getElementById('p_nom').value='';
                document.getElementById('p_naixement').value='';
                document.getElementById('p_revisio').checked=false;
                document.getElementById('p_inscripcio').checked=false;
                document.getElementById('p_pagament_fcf').checked=false;
                document.getElementById('p_vinculat_club').checked=false;
                renderPlantilla();
                await saveAll(true);
                return;
            }

            try{
                const r=await fetch(API_JUGADORS,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({equip_id:EQUIP_ID,nom,any_naixement:naixement,revisio_medica:revisio,inscripcio_feta:inscripcio,pagament_fcf_fet:pagamentFcf,vinculat_club:vinculatClub})});
                if(!r.ok){
                    const errorText=await r.text();
                    throw new Error(`POST jugadors ${r.status}: ${errorText}`);
                }
                const payload=await r.json();
                const created=payload&&payload.jugador?payload.jugador:null;
                if(created){
                    plantilla.push({id:String(created.id),nom:created.nom||nom,naixement:normalizeBirthYear(created.any_naixement||created.naixement||naixement),revisio:toBool(created.revisio),inscripcio:toBool(created.inscripcio_feta ?? inscripcio),pagament_fcf:toBool(created.pagament_fcf_fet ?? pagamentFcf),vinculat_club:toBool(created.vinculat_club ?? vinculatClub)});
                    plantilla.sort((a,b)=>(a.nom||'').localeCompare(b.nom||''));
                }
            }catch(e){
                alert('Error al crear jugadora');
            }
            document.getElementById('p_nom').value='';
            document.getElementById('p_naixement').value='';
            document.getElementById('p_revisio').checked=false;
                document.getElementById('p_inscripcio').checked=false;
                document.getElementById('p_pagament_fcf').checked=false;
                document.getElementById('p_vinculat_club').checked=false;
                renderPlantilla();
        };

        function renderCaptacioSuggestions(){
            const container=document.getElementById('captacio_suggestions');
            const captacioTitle=document.getElementById('captacio_title');
            if(captacioTitle){
                if(!captacioTitle.dataset.baseTitle) captacioTitle.dataset.baseTitle=captacioTitle.innerHTML.replace(/\s*\(\d+\)\s*$/,'');
                captacioTitle.innerHTML=captacioTitle.dataset.baseTitle+' ('+(captacioSuggestions?captacioSuggestions.length:0)+')';
            }
            if(!container) return;
            if(!captacioSuggestions||!captacioSuggestions.length){
                container.innerHTML='<div class="empty-msg">No hi ha jugadores en captació que coincideixin amb aquest equip.</div>';
                return;
            }
            container.innerHTML=captacioSuggestions.map(p=>{
                const posicions=Array.isArray(p.posicions)?p.posicions.join(', '):'';
                const club=p.club?`<strong>Club:</strong> ${esc(p.club)}<br>`:'';
                const tel=p.tel?`<strong>Tel:</strong> ${esc(p.tel)}<br>`:'';
                const poblacio=p.poblacio?`<strong>Població:</strong> ${esc(p.poblacio)}<br>`:'';
                const situacio=p.situacio?`<strong>Situació:</strong> ${esc(p.situacio)}`:'';
                const genderBadge=p.genere==='Masculí'?'<span class="gender-masculi" style="font-size:0.7rem;font-weight:700;padding:0.2rem 0.5rem;border-radius:1rem;background:#dbeafe;color:#1d4ed8;margin-left:0.5rem;">'+esc(p.genere)+'</span>':'<span class="gender-femeni" style="font-size:0.7rem;font-weight:700;padding:0.2rem 0.5rem;border-radius:1rem;background:#fce7f3;color:#be185d;margin-left:0.5rem;">'+esc(p.genere)+'</span>';
                const yearBadge='<span class="year-badge" style="font-size:0.7rem;font-weight:700;padding:0.2rem 0.5rem;border-radius:1rem;background:#fef3c7;color:#92400e;margin-left:0.5rem;">'+esc(normalizeBirthYear(p.any_naixement||p.naixement||''))+'</span>';
                return '<div class="obs-item" style="background:#f0fdf4;border:1px solid #86efac;"><div class="obs-header"><div style="font-size:0.95rem;"><strong style="color:#059669;">'+esc(p.nom||'Sense nom')+'</strong>'+genderBadge+yearBadge+'</div></div><div style="font-size:0.82rem;color:#475569;line-height:1.6;">'+club+tel+poblacio+'<strong>Posicions:</strong> '+esc(posicions)+'<br>'+situacio+'</div></div>';
            }).join('');
        }

        window.updatePlayer=function(index,field,value){
            if(!plantilla[index]) return;
            if(field==='revisio') plantilla[index].revisio=!!value;
            if(field==='inscripcio') plantilla[index].inscripcio=!!value;
            if(field==='pagament_fcf') plantilla[index].pagament_fcf=!!value;
            if(field==='vinculat_club') plantilla[index].vinculat_club=!!value;
            if(field==='nom') plantilla[index].nom=value;
            if(field==='naixement') plantilla[index].naixement=normalizeBirthYear(value);

            if(field==='naixement' && !isValidBirthYear(plantilla[index].naixement)){
                renderPlantilla();
                return;
            }

            if(IS_FILE){
                saveAll(true);
                return;
            }

            const player=plantilla[index];
            if(!isNumericId(player.id)) return;
            const body={id:player.id};
            if(field==='nom') body.nom=player.nom;
            if(field==='naixement') body.any_naixement=player.naixement;
            if(field==='revisio') body.revisio_medica=player.revisio;
            if(field==='inscripcio') body.inscripcio_feta=player.inscripcio;
            if(field==='pagament_fcf') body.pagament_fcf_fet=player.pagament_fcf;
            if(field==='vinculat_club') body.vinculat_club=player.vinculat_club;

            fetch(API_JUGADORS,{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)})
                .then(async r=>{if(!r.ok){const errorText=await r.text();throw new Error(errorText);}})
                .catch(()=>{console.warn('No s\'ha pogut actualitzar la jugadora');});
        };

        window.removePlayer=async function(index){
            if(!confirm('Segur que vols eliminar aquesta jugadora?')) return;
            if(!plantilla[index]) return;
            const player=plantilla[index];

            if(IS_FILE || !isNumericId(player.id)){
                plantilla.splice(index,1);
                renderPlantilla();
                if(IS_FILE) await saveAll(true);
                return;
            }

            try{
                const r=await fetch(`${API_JUGADORS}?id=${encodeURIComponent(player.id)}`,{method:'DELETE'});
                if(!r.ok){
                    const errorText=await r.text();
                    throw new Error(`DELETE jugadors ${r.status}: ${errorText}`);
                }
                plantilla.splice(index,1);
                renderPlantilla();
            }catch(e){
                alert('Error al eliminar jugadora');
            }
        };

        const today=new Date().toISOString().split('T')[0];
        if(document.getElementById('obs_data')) document.getElementById('obs_data').value=today;
        window.addObs=async function(){
            const text=document.getElementById('obs_text').value.trim(); if(!text)return;
            observacions.unshift({autor:document.getElementById('obs_autor').value||'Anònim',
                data:document.getElementById('obs_data').value,text});
            document.getElementById('obs_text').value='';
            document.getElementById('obs_autor').value='';
            document.getElementById('obs_data').value=today;
            renderObs();
            await saveAll(true);
        };
        window.removeObs=async function(i){
            if(!confirm('Segur que vols eliminar aquest comentari?')) return;
            observacions.splice(i,1);
            renderObs();
            await saveAll(true);
        };
        function renderObs(){
            const el=document.getElementById('obs_list'); if(!el)return;
            if(!observacions.length){el.innerHTML='<div class="empty-msg">Sense observacions registrades.</div>';return;}
            el.innerHTML=observacions.map((o,i)=>'<div class="obs-item"><div class="obs-header"><div class="obs-meta"><strong>'+esc(o.autor)+'</strong> &mdash; '+fmtDate(o.data)+'</div><button class="btn-remove" onclick="removeObs('+i+')">&#x00D7;</button></div><div class="obs-text">'+esc(o.text)+'</div></div>').join('');
        }

        function fmtDate(d){if(!d)return'-';return new Date(d+'T12:00:00').toLocaleDateString('ca-ES',{day:'2-digit',month:'2-digit',year:'numeric'});}
        function esc(t){if(!t && t!==0)return'';return String(t).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
        load();
    </script>
</body>
</html>

